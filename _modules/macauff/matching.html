<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>macauff.matching &#8212; macauff</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4848ba22" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css?v=a5b9c134" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.matching</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for macauff.matching</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">This module provides the high-level framework for performing catalogue-catalogue cross-matches.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">configparser</span> <span class="kn">import</span> <span class="n">ConfigParser</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">MPI</span> <span class="o">=</span> <span class="kc">None</span>

<span class="kn">from</span> <span class="nn">.perturbation_auf</span> <span class="kn">import</span> <span class="n">make_perturb_aufs</span>
<span class="kn">from</span> <span class="nn">.group_sources</span> <span class="kn">import</span> <span class="n">make_island_groupings</span>
<span class="kn">from</span> <span class="nn">.group_sources_fortran</span> <span class="kn">import</span> <span class="n">group_sources_fortran</span> <span class="k">as</span> <span class="n">gsf</span>
<span class="kn">from</span> <span class="nn">.misc_functions_fortran</span> <span class="kn">import</span> <span class="n">misc_functions_fortran</span> <span class="k">as</span> <span class="n">mff</span>
<span class="kn">from</span> <span class="nn">.photometric_likelihood</span> <span class="kn">import</span> <span class="n">compute_photometric_likelihoods</span>
<span class="kn">from</span> <span class="nn">.counterpart_pairing</span> <span class="kn">import</span> <span class="n">source_pairing</span>
<span class="kn">from</span> <span class="nn">.parse_catalogue</span> <span class="kn">import</span> <span class="n">npy_to_csv</span><span class="p">,</span> <span class="n">csv_to_npy</span>
<span class="kn">from</span> <span class="nn">.fit_astrometry</span> <span class="kn">import</span> <span class="n">AstrometricCorrections</span><span class="p">,</span> <span class="n">SNRMagnitudeRelationship</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;CrossMatch&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="CrossMatch">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch">[docs]</a>
<span class="k">class</span> <span class="nc">CrossMatch</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    A class to cross-match two photometric catalogues with one another, producing</span>
<span class="sd">    a composite catalogue of merged sources.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    chunks_folder_path : string</span>
<span class="sd">        A path to the location of the folder containing one subfolder per chunk.</span>
<span class="sd">    resume_file_path : string, optional</span>
<span class="sd">        A path to the location of the file containing resume information for the</span>
<span class="sd">        cross match.</span>
<span class="sd">    use_mpi : boolean, optional</span>
<span class="sd">        Enable/disable the use of MPI parallelisation (enabled by default).</span>
<span class="sd">    walltime : string, optional</span>
<span class="sd">        Maximum runtime of the cross-match job in format &#39;HH:MM:SS&#39; (hours, minutes</span>
<span class="sd">        and seconds). Controls checkpointing.</span>
<span class="sd">    end_within : string, optional</span>
<span class="sd">        End time in &#39;HH:MM:SS&#39; format (hours, minutes and seconds). Default is</span>
<span class="sd">        &#39;00:10:00&#39;, i.e. end within 10 minutes of the given walltime.</span>
<span class="sd">    polling_rate : integer, optional</span>
<span class="sd">        Rate in seconds at which manager process checks for new work requests and</span>
<span class="sd">        monitors walltime. Default is 1 second.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunks_folder_path</span><span class="p">,</span> <span class="n">resume_file_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_mpi</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">walltime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">end_within</span><span class="o">=</span><span class="s1">&#39;00:10:00&#39;</span><span class="p">,</span> <span class="n">polling_rate</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialisation function for cross-match class.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks_folder_path</span> <span class="o">=</span> <span class="n">chunks_folder_path</span>

        <span class="c1"># Initialise MPI if available and enabled</span>
        <span class="k">if</span> <span class="n">MPI</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">use_mpi</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">MPI</span><span class="o">.</span><span class="n">COMM_WORLD</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_size</span><span class="p">()</span>
            <span class="c1"># Set MPI error handling to return exceptions rather than MPI_Abort the</span>
            <span class="c1"># application. Allows for recovery of crashed workers.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Set_errhandler</span><span class="p">(</span><span class="n">MPI</span><span class="o">.</span><span class="n">ERRORS_RETURN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_mpi</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: MPI initialisation failed. Check mpi4py is correctly installed. Falling back to serial mode.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">comm_size</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Special signals for MPI processes</span>
        <span class="c1">#   &#39;NO_MORE_WORK&#39; - manager uses to signal workers to shut down</span>
        <span class="c1">#   &#39;WORK_REQUEST&#39; - manager uses to signal new chunk for processing.</span>
        <span class="c1">#                    worker uses to request initial chunk from manager.</span>
        <span class="c1">#   &#39;WORK_COMPLETE&#39; - worker uses to report successfully processed given chunk</span>
        <span class="c1">#   &#39;WORK_ERROR&#39; - worker uses to report failed processing of given chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;NO_MORE_WORK&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s1">&#39;WORK_REQUEST&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="s1">&#39;WORK_COMPLETE&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
                                <span class="s1">&#39;WORK_ERROR&#39;</span><span class="p">:</span> <span class="mi">3</span> <span class="p">}</span>
        <span class="c1"># Only manager process needs to set up the resume file and queue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">completed_chunks</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Open and read existing resume file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resume_file_path</span><span class="p">,</span> <span class="s1">&#39;r+&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="p">:</span>
                    <span class="n">completed_chunks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>
            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                <span class="c1"># Resume file specified but does not exist. Create new one.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">resume_file_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="c1"># Resume file was not specified. Disable checkpointing</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># Chunk queue will not contain chunks recorded as completed in the</span>
            <span class="c1"># resume file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">chunk_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_chunk_queue</span><span class="p">(</span><span class="n">completed_chunks</span><span class="p">)</span>
            <span class="c1"># Used to keep track of progress to completion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_chunks_to_process</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_queue</span><span class="p">)</span>

            <span class="c1"># In seconds, how often the manager checks for new work requests</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polling_rate</span> <span class="o">=</span> <span class="n">polling_rate</span>

            <span class="k">if</span> <span class="n">walltime</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Expect job walltime and &quot;end within&quot; time in Hours:Minutes:Seconds (%H:%M:%S)</span>
                <span class="c1"># format, e.g. 02:44:12 for 2 hours, 44 minutes, 12 seconds</span>
                <span class="c1"># Calculate job end time from start time + walltime</span>
                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">walltime</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> \
                    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">),</span> <span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">minute</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">second</span><span class="p">))</span>
                <span class="c1"># Keep track of &quot;end within&quot; time as a timedelta for easy comparison</span>
                <span class="n">hour</span><span class="p">,</span> <span class="n">minute</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">end_within</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_within</span> <span class="o">=</span> \
                    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">hour</span><span class="p">),</span> <span class="n">minutes</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">minute</span><span class="p">),</span> <span class="n">seconds</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">second</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">end_within</span> <span class="o">=</span> <span class="kc">None</span>


    <span class="k">def</span> <span class="nf">_initialise_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialisation function for a single chunk of sky.</span>

<span class="sd">        The function takes three paths, the locations of the metadata files containing</span>
<span class="sd">        all of the necessary parameters for the cross-match, and outputs a file</span>
<span class="sd">        containing the appropriate columns of the datasets plus additional derived</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_file_path : string</span>
<span class="sd">            A path to the location of the file containing the cross-match metadata.</span>
<span class="sd">        cat_a_file_path : string</span>
<span class="sd">            A path to the location of the file containing the catalogue &quot;a&quot; specific</span>
<span class="sd">            metadata.</span>
<span class="sd">        cat_b_file_path : string</span>
<span class="sd">            A path to the location of the file containing the catalogue &quot;b&quot; specific</span>
<span class="sd">            metadata.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;Input parameter file </span><span class="si">{}</span><span class="s2"> could not be found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_file_path</span> <span class="o">=</span> <span class="n">joint_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_a_file_path</span> <span class="o">=</span> <span class="n">cat_a_file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_b_file_path</span> <span class="o">=</span> <span class="n">cat_b_file_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">()</span>

        <span class="c1"># If astrometry of either catalogue needs fixing, do that now.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="c1"># Generate from current data: just need the singular chunk mid-points</span>
            <span class="c1"># and to leave all other parameters as they are.</span>
            <span class="n">ax1_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)])</span>
            <span class="n">ax2_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)])</span>
            <span class="n">ax_dimension</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">a_npy_or_csv</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
            <span class="n">a_coord_or_chunk</span> <span class="o">=</span> <span class="s1">&#39;chunk&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span><span class="p">:</span>
            <span class="n">acbi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_best_mag_index</span>
            <span class="n">a_correct_astro_tri_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation&#39;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Calculating catalogue &#39;a&#39; uncertainty corrections...&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">AstrometricCorrections</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_psf_fwhms</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_nn_radius</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_dens_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astro_save_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span>
                <span class="n">a_correct_astro_tri_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_maglim_faint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_num</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_num_faint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_set_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_names</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_wavs</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_aboffsets</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_filternames</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_al_avs</span><span class="p">[</span><span class="n">acbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_l_cut</span><span class="p">,</span> <span class="n">ax1_mids</span><span class="p">,</span>
                <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_mag_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_mag_slice</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_sig_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span><span class="p">,</span> <span class="n">a_npy_or_csv</span><span class="p">,</span> <span class="n">a_coord_or_chunk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_pos_and_err_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_mag_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_mag_unc_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_best_mag_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span><span class="p">,</span>
                <span class="n">use_photometric_uncertainties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_use_photometric_uncertainties</span><span class="p">,</span>
                <span class="n">pregenerate_cutouts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">])</span>
            <span class="n">ac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_ref_csv_cat_file_string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_csv_cat_file_string</span><span class="p">,</span>
               <span class="n">tri_download</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Having corrected the astrometry, we have to call csv_to_npy</span>
            <span class="c1"># now, rather than pre-generating our binary input catalogues.</span>
            <span class="n">csv_folder</span><span class="p">,</span> <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_csv_cat_file_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">csv_to_npy</span><span class="p">(</span><span class="n">csv_folder</span><span class="p">,</span> <span class="n">csv_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">a_pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_mag_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_best_mag_index_col</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">a_chunk_overlap_col</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">process_uncerts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">astro_sig_fits_filepath</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astro_save_folder</span><span class="p">),</span>
                       <span class="n">cat_in_radec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span><span class="p">,</span>
                       <span class="n">mn_in_radec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Calculating catalogue &#39;a&#39; SNR-mag relations...&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">smr</span> <span class="o">=</span> <span class="n">SNRMagnitudeRelationship</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astro_save_folder</span><span class="p">,</span> <span class="n">ax1_mids</span><span class="p">,</span> <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="n">a_npy_or_csv</span><span class="p">,</span>
                <span class="n">a_coord_or_chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_pos_and_err_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_mag_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_mag_unc_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">])</span>
            <span class="n">smr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_csv_cat_file_string</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="c1"># If we re-made either side&#39;s astrometry then we need to load its</span>
            <span class="c1"># SNR-mag relation now.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp </span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astro_save_folder</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">a_snr_mag_params_path</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;snr_mag_params&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_snr_mag_params_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> file not found in catalogue </span><span class="si">{}</span><span class="s1"> path. &#39;</span>
                                        <span class="s1">&#39;Please ensure </span><span class="si">{}</span><span class="s1"> are pre-generated.&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s1">&#39;astrometry corrections&#39;</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_snr_mag_params_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;a_snr_mag_params should be of shape (X, Y, 5)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_snr_mag_params</span> <span class="o">=</span> <span class="n">a</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="c1"># Generate from current data: just need the singular chunk mid-points</span>
            <span class="c1"># and to leave all other parameters as they are.</span>
            <span class="n">ax1_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)])</span>
            <span class="n">ax2_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mf">0.1</span><span class="p">)])</span>
            <span class="n">ax_dimension</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">b_npy_or_csv</span> <span class="o">=</span> <span class="s1">&#39;csv&#39;</span>
            <span class="n">b_coord_or_chunk</span> <span class="o">=</span> <span class="s1">&#39;chunk&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span><span class="p">:</span>
            <span class="n">bcbi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_best_mag_index</span>
            <span class="n">b_correct_astro_tri_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation&#39;</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Calculating catalogue &#39;b&#39; uncertainty corrections...&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">ac</span> <span class="o">=</span> <span class="n">AstrometricCorrections</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_psf_fwhms</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_nn_radius</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_dens_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astro_save_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span>
                <span class="n">b_correct_astro_tri_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_maglim_faint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_num</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_num_faint</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_set_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_names</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_wavs</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_aboffsets</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_filternames</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_al_avs</span><span class="p">[</span><span class="n">bcbi</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dd_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_l_cut</span><span class="p">,</span> <span class="n">ax1_mids</span><span class="p">,</span>
                <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_mag_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_mag_slice</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_sig_slice</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span><span class="p">,</span> <span class="n">b_npy_or_csv</span><span class="p">,</span> <span class="n">b_coord_or_chunk</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_pos_and_err_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_mag_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_mag_unc_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_best_mag_index</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span><span class="p">,</span>
                <span class="n">use_photometric_uncertainties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_use_photometric_uncertainties</span><span class="p">,</span>
                <span class="n">pregenerate_cutouts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">])</span>
            <span class="n">ac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_ref_csv_cat_file_string</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_csv_cat_file_string</span><span class="p">,</span>
               <span class="n">tri_download</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">csv_folder</span><span class="p">,</span> <span class="n">csv_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_csv_cat_file_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">csv_to_npy</span><span class="p">(</span><span class="n">csv_folder</span><span class="p">,</span> <span class="n">csv_filename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">b_pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_mag_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_best_mag_index_col</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">b_chunk_overlap_col</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">process_uncerts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">astro_sig_fits_filepath</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astro_save_folder</span><span class="p">),</span>
                       <span class="n">cat_in_radec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span><span class="p">,</span>
                       <span class="n">mn_in_radec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Calculating catalogue &#39;b&#39; SNR-mag relations...&quot;</span>
                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
            <span class="n">smr</span> <span class="o">=</span> <span class="n">SNRMagnitudeRelationship</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astro_save_folder</span><span class="p">,</span> <span class="n">ax1_mids</span><span class="p">,</span> <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="n">b_npy_or_csv</span><span class="p">,</span>
                <span class="n">b_coord_or_chunk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_pos_and_err_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_mag_indices</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_mag_unc_indices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span><span class="p">,</span>
                <span class="n">chunks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">])</span>
            <span class="n">smr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_csv_cat_file_string</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;cp </span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astro_save_folder</span><span class="p">,</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">b_snr_mag_params_path</span><span class="p">))</span>
            <span class="n">f</span> <span class="o">=</span> <span class="s1">&#39;snr_mag_params&#39;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_snr_mag_params_path</span><span class="p">,</span> <span class="n">f</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> file not found in catalogue </span><span class="si">{}</span><span class="s1"> path. &#39;</span>
                                        <span class="s1">&#39;Please ensure </span><span class="si">{}</span><span class="s1"> are pre-generated.&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s1">&#39;astrometry corrections&#39;</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_snr_mag_params_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;b_snr_mag_params should be of shape (X, Y, 5)&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_snr_mag_params</span> <span class="o">=</span> <span class="n">a</span>

        <span class="c1"># Ensure that we can create the folders for outputs.</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;reject&#39;</span><span class="p">,</span> <span class="s1">&#39;pairing&#39;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create temporary folder for joint outputs. &quot;</span>
                              <span class="s2">&quot;Please ensure that joint_folder_path is correct.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">],</span>
                                       <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create temporary folder for catalogue </span><span class="si">{}</span><span class="s2"> AUF &quot;</span>
                              <span class="s2">&quot;outputs. Please ensure that </span><span class="si">{}</span><span class="s2">auf_folder_path is correct.&quot;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>

        <span class="c1"># Unlike the AUF folder paths, which are allowed to not exist at</span>
        <span class="c1"># runtime, we simply check that cat_folder_path exists for both</span>
        <span class="c1"># input catalogues, with three appropriately shaped arrays in it,</span>
        <span class="c1"># and error if not.</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">],</span>
                                       <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_folder_path does not exist. Please ensure that &#39;</span>
                              <span class="s1">&#39;path for catalogue </span><span class="si">{}</span><span class="s1"> is correct.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Currently forcing hard-coded three-part numpy array names,</span>
                <span class="c1"># to come out of &quot;skinny table&quot; consolidated catalogue</span>
                <span class="c1"># generation.</span>
                <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;con_cat_astro&#39;</span><span class="p">,</span> <span class="s1">&#39;con_cat_photo&#39;</span><span class="p">,</span> <span class="s1">&#39;magref&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> file not found in catalogue </span><span class="si">{}</span><span class="s1"> path. &#39;</span>
                                                <span class="s1">&#39;Please run catalogue consolidation&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                    <span class="n">file_name</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                <span class="c1"># Shape, mapped to each of astro/photo/magref respectively,</span>
                <span class="c1"># should map to 3, number of magnitudes, and 1, where magref is</span>
                <span class="c1"># a 1-D array but the other two are 2-D.</span>
                <span class="n">fn_a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_astro.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="n">fn_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/con_cat_photo.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="n">fn_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/magref.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">fn_m</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Incorrect number of dimensions in consolidated &quot;</span>
                                     <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> files.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Second dimension of con_cat_astro in catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;should be 3.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Second dimension of con_cat_photo in catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;should be the same as the number of filters listed &quot;</span>
                                     <span class="s2">&quot;in </span><span class="si">{}</span><span class="s2">filt_names.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">fn_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">fn_p</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">fn_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Consolidated catalogue arrays for catalogue </span><span class="si">{}</span><span class="s2"> should &quot;</span>
                                     <span class="s2">&quot;all be consistent lengths.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_shared_data</span><span class="p">()</span>

<div class="viewcode-block" id="CrossMatch.__call__">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Call function for CrossMatch, performs cross-matching two photometric catalogues.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Special case for single process, i.e. serial version of code.</span>
        <span class="c1"># Do not use manager-worker pattern. Instead, one process loops over all chunks</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_queue</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1"> processing chunk </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span> <span class="o">=</span> <span class="n">chunk_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_process_chunk</span><span class="p">(</span><span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk_id</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Manager process:</span>
            <span class="c1">#   - assigns chunks to workers</span>
            <span class="c1">#   - receives notification of completed or failed cross-matches</span>
            <span class="c1">#   - writes completed chunk IDs to resume file</span>
            <span class="c1">#   - TODO handle crashed workers (segfaults in Fortran routines currently unrecoverable)</span>
            <span class="c1">#   - TODO handle crashed manager process</span>
            <span class="c1">#   - once queue is empty, workers are sent signal to stop</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Maintain count of active workers.</span>
                <span class="c1"># Initially every process other than manager.</span>
                <span class="n">active_workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm_size</span> <span class="o">-</span> <span class="mi">1</span>

                <span class="c1"># Loop until all workers have been instructed there is no more work</span>
                <span class="n">out_of_walltime</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">while</span> <span class="n">active_workers</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># If checkpointing disabled, simply wait for any worker to</span>
                    <span class="c1"># request a chunk and report completion of any previous chunk</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                    <span class="c1"># Otherwise, use non-blocking recv to allow manager to keep</span>
                    <span class="c1"># track of job time via polling loop</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">req</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">irecv</span><span class="p">()</span>
                        <span class="c1"># Use an infinite loop with break rather than &quot;while not req.Get_status()&quot;</span>
                        <span class="c1"># to ensure walltime is checked even if request returns immediately, i.e.</span>
                        <span class="c1"># emulate a &quot;do-while&quot; loop</span>
                        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="c1"># Check if we&#39;re reaching the limit of job walltime. If so,</span>
                            <span class="c1"># empty the queue so no further work is issued</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_within</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">: reaching job walltime. Cancelling all further &#39;</span>
                                      <span class="s1">&#39;work. </span><span class="si">{}</span><span class="s1"> chunks remain unprocessed.&#39;</span>
                                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_chunks_to_process</span><span class="p">))</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">chunk_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                                <span class="c1"># Blank end time so we don&#39;t re-enter polling loop</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">Get_status</span><span class="p">():</span>
                                <span class="k">break</span>
                            <span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">polling_rate</span><span class="p">)</span>
                        <span class="c1"># Request complete, extract data</span>
                        <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

                    <span class="c1"># Record completed chunk</span>
                    <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_COMPLETE&#39;</span><span class="p">]</span> \
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">: chunk </span><span class="si">{}</span><span class="s1"> processed by rank </span><span class="si">{}</span><span class="s1">. Adding to resume file.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">chunk_id</span><span class="o">+</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="c1"># Do not buffer. Immediately commit to disk for</span>
                        <span class="c1"># resilience against crashes and overrunning walltime</span>
                        <span class="c1"># flush() alone is not enough. See:</span>
                        <span class="c1"># https://docs.python.org/3/library/os.html#os.fsync</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="p">)</span>
                        <span class="c1"># Update number of remaining chunks to process</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">num_chunks_to_process</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="c1"># Handle failed chunk</span>
                    <span class="k">elif</span> <span class="n">signal</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_ERROR&#39;</span><span class="p">]:</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">: rank </span><span class="si">{}</span><span class="s1"> failed to process chunk </span><span class="si">{}</span><span class="s1">.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">))</span>

                    <span class="c1"># Assign chunks until no more work.</span>
                    <span class="c1"># Then count &quot;no more work&quot; signals until no more workers.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_chunk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_queue</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_REQUEST&#39;</span><span class="p">]</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">: sending rank </span><span class="si">{}</span><span class="s1"> chunk </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                              <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">worker_id</span><span class="p">,</span> <span class="n">new_chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="n">new_chunk</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;NO_MORE_WORK&#39;</span><span class="p">]</span>
                        <span class="n">active_workers</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">signal</span><span class="p">,</span> <span class="n">new_chunk</span><span class="p">),</span> <span class="n">dest</span><span class="o">=</span><span class="n">worker_id</span><span class="p">)</span>

            <span class="c1"># Worker processes:</span>
            <span class="c1">#  - request chunk from manager</span>
            <span class="c1">#  - loop until given signal to terminate</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_REQUEST&#39;</span><span class="p">]</span>
                <span class="n">completed_chunk_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># Infinite loop until given signal to break</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="c1"># Send own rank ID to manager so it knows which process to assign work</span>
                    <span class="c1"># in addition to signal and completed chunk id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">send</span><span class="p">((</span><span class="n">signal</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">completed_chunk_id</span><span class="p">),</span> <span class="n">dest</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">chunk</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

                    <span class="c1"># Handle received signal.</span>
                    <span class="c1"># Terminate when signalled there is no more work...</span>
                    <span class="k">if</span> <span class="n">signal</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;NO_MORE_WORK&#39;</span><span class="p">]:</span>
                        <span class="k">break</span>
                    <span class="c1"># ...or process the given chunk</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">chunk</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span> <span class="o">=</span> <span class="n">chunk_id</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">: processing chunk </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">))</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_process_chunk</span><span class="p">(</span><span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span>
                            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_COMPLETE&#39;</span><span class="p">]</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># Recover worker on chunk processing error</span>
                            <span class="n">signal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">worker_signals</span><span class="p">[</span><span class="s1">&#39;WORK_ERROR&#39;</span><span class="p">]</span>
                            <span class="c1"># TODO More granular error handling</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">: failed to process chunk </span><span class="si">{}</span><span class="s2">. Exception: </span><span class="si">{}</span><span class="s2">&quot;</span>
                                  <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                        <span class="n">completed_chunk_id</span> <span class="o">=</span> <span class="n">chunk_id</span>

                    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="c1"># Clean up and shut down</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">()</span></div>



    <span class="k">def</span> <span class="nf">_process_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Runs the various stages of cross-matching two photometric catalogues</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Initialise using the current chunk data</span>
        <span class="c1"># TODO Move some initialisation into class constructor?</span>
        <span class="c1"># TODO Have manager perform file loads and broadcast result to reduce I/O</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialise_chunk</span><span class="p">(</span><span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span>

        <span class="c1"># The first step is to create the perturbation AUF components, if needed.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_perturb_auf</span><span class="p">()</span>

        <span class="c1"># Once AUF components are assembled, we now group sources based on</span>
        <span class="c1"># convolved AUF integration lengths, to get &quot;common overlap&quot; sources</span>
        <span class="c1"># and merge such overlaps into distinct &quot;islands&quot; of sources to match.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sources</span><span class="p">()</span>

        <span class="c1"># The third step in this process is to, to some level, calculate the</span>
        <span class="c1"># photometry-related information necessary for the cross-match.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calculate_phot_like</span><span class="p">()</span>

        <span class="c1"># The final stage of the cross-match process is that of putting together</span>
        <span class="c1"># the previous stages, and calculating the cross-match probabilities.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_sources</span><span class="p">()</span>

        <span class="c1"># Following cross-match completion, perform post-processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postprocess_chunk</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_postprocess_chunk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Runs the post-processing stage, resolving duplicate cross-matches and</span>
<span class="sd">        optionally creating output .csv files for use elsewhere.</span>

<span class="sd">        Duplicates are determined by match pairs (or singular non-matches) that</span>
<span class="sd">        are entirely outside of the &quot;core&quot; for a given chunk. This core/halo</span>
<span class="sd">        divide is defined by the ``in_chunk_overlap`` array; if only a singular</span>
<span class="sd">        chunk is being matched (i.e., there is no compartmentalisation of a</span>
<span class="sd">        larger region), then ``in_chunk_overlap`` should all be set to ``False``.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Removing halo matches and non-matches...&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>

        <span class="n">ac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/ac.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bc.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>

        <span class="n">af</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/af.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
        <span class="n">bf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bf.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>

        <span class="n">a_in_overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/in_chunk_overlap.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">))</span>
        <span class="n">b_in_overlaps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/in_chunk_overlap.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">))</span>

        <span class="n">core_matches</span> <span class="o">=</span> <span class="o">~</span><span class="n">a_in_overlaps</span><span class="p">[</span><span class="n">ac</span><span class="p">]</span> <span class="o">|</span> <span class="o">~</span><span class="n">b_in_overlaps</span><span class="p">[</span><span class="n">bc</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/ac.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">ac</span><span class="p">[</span><span class="n">core_matches</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bc.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">bc</span><span class="p">[</span><span class="n">core_matches</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pc&#39;</span><span class="p">,</span> <span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="s1">&#39;xi&#39;</span><span class="p">,</span> <span class="s1">&#39;crptseps&#39;</span><span class="p">,</span> <span class="s1">&#39;acontamflux&#39;</span><span class="p">,</span> <span class="s1">&#39;bcontamflux&#39;</span><span class="p">]:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">))[</span>
                        <span class="n">core_matches</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;pacontam&#39;</span><span class="p">,</span> <span class="s1">&#39;pbcontam&#39;</span><span class="p">]:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">))[</span>
                        <span class="p">:,</span> <span class="n">core_matches</span><span class="p">])</span>

        <span class="n">a_core_nonmatches</span> <span class="o">=</span> <span class="o">~</span><span class="n">a_in_overlaps</span><span class="p">[</span><span class="n">af</span><span class="p">]</span>
        <span class="n">b_core_nonmatches</span> <span class="o">=</span> <span class="o">~</span><span class="n">b_in_overlaps</span><span class="p">[</span><span class="n">bf</span><span class="p">]</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/af.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">af</span><span class="p">[</span><span class="n">a_core_nonmatches</span><span class="p">])</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/bf.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">),</span> <span class="n">bf</span><span class="p">[</span><span class="n">b_core_nonmatches</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">fnametype</span><span class="p">,</span> <span class="n">cnm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">],</span> <span class="p">[</span><span class="n">a_core_nonmatches</span><span class="p">,</span> <span class="n">b_core_nonmatches</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">fname_</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fieldflux&#39;</span><span class="p">,</span> <span class="s1">&#39;pf</span><span class="si">{}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fieldeta&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fieldxi&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fieldseps&#39;</span><span class="p">]:</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fname_</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fnametype</span><span class="p">)</span>
                <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pairing/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="n">fname</span><span class="p">))[</span><span class="n">cnm</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_output_csv</span><span class="p">:</span>
            <span class="n">npy_to_csv</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_input_csv_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_input_csv_folder</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_csv_folder</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_csv_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_csv_name</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">match_out_csv_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_nonmatch_out_csv_name</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">b_nonmatch_out_csv_name</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_col_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_col_names</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_col_nums</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_col_nums</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_input_npy_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_input_npy_folder</span><span class="p">],</span>
                <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_csv_has_header</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_csv_has_header</span><span class="p">],</span>
                <span class="n">extra_col_name_lists</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_extra_col_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_extra_col_names</span><span class="p">],</span>
                <span class="n">extra_col_num_lists</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_extra_col_nums</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_extra_col_nums</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_make_chunk_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">completed_chunks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Determines the order with which chunks will be processed</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chunk_queue : list of tuples of strings</span>
<span class="sd">            List with one element per chunk. Each element a tuple of chunk ID and</span>
<span class="sd">            paths to metadata files in order (ID, cross-match, catalogue &quot;a&quot;, catalogue &quot;b&quot;)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># Each metadata file associated with a chunk assumed to be in a subfolder</span>
        <span class="c1"># e.g. Two chunks, &quot;2017&quot; and &quot;2018&quot;, have structure:</span>
        <span class="c1">#   chunks_folder_path/2017/crossmatch_params_2017.txt</span>
        <span class="c1">#   chunks_folder_path/2017/cat_a_params_2017.txt</span>
        <span class="c1">#   chunks_folder_path/2017/cat_b_params_2017.txt</span>
        <span class="c1">#   chunks_folder_path/2018/crossmatch_params_2018.txt</span>
        <span class="c1">#   chunks_folder_path/2018/cat_a_params_2018.txt</span>
        <span class="c1">#   chunks_folder_path/2018/cat_b_params_2018.txt</span>

        <span class="c1"># Loop over subfolders in chunks folder, extracting paths to metadata files contained within</span>
        <span class="n">chunk_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_folder_path</span><span class="p">):</span>
            <span class="n">folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks_folder_path</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>

            <span class="c1"># Skip non-directories</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="c1"># Skip completed chunks</span>
            <span class="k">if</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">completed_chunks</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Identify chunk by subfolder name</span>
            <span class="n">chunk_id</span> <span class="o">=</span> <span class="n">folder</span>
            <span class="n">joint_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">cat_a_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">cat_b_file_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">):</span>
                <span class="c1"># Ignore non-txt files</span>
                <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
                    <span class="c1"># TODO Relying on particular naming convention for metadata files</span>
                    <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;crossmatch_params&quot;</span><span class="p">):</span>
                        <span class="n">joint_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cat_a_params&quot;</span><span class="p">):</span>
                        <span class="n">cat_a_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cat_b_params&quot;</span><span class="p">):</span>
                        <span class="n">cat_b_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

            <span class="c1"># Check results</span>
            <span class="k">if</span> <span class="n">joint_file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Cross-match metadata file for chunk </span><span class="si">{}</span><span class="s1"> not found in directory </span><span class="si">{}</span><span class="s1">&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cat_a_file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Catalogue &quot;a&quot; metadata file for chunk </span><span class="si">{}</span><span class="s1"> not found in directory </span><span class="si">{}</span><span class="s1">&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cat_b_file_path</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Catalogue &quot;b&quot; metadata file for chunk </span><span class="si">{}</span><span class="s1"> not found in directory </span><span class="si">{}</span><span class="s1">&#39;</span>
                                        <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">folder_path</span><span class="p">))</span>

            <span class="c1"># Determine combined input file size for catalogues &quot;a&quot; and &quot;b&quot;</span>
            <span class="c1"># Used to sort queue</span>
            <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="p">[</span><span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">]:</span>
                <span class="c1"># Read input folder path from metadata file.</span>
                <span class="c1"># TODO: Use ConfigParser here?</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">param_file</span><span class="p">:</span>
                    <span class="n">cat_folder_path</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">param_file</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cat_folder_path&quot;</span><span class="p">):</span>
                            <span class="n">cat_folder_path</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cat_folder_path</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;Catalogue directory </span><span class="si">{}</span><span class="s1"> not found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cat_folder_path</span><span class="p">))</span>

                <span class="c1"># Get size of all files in input folder</span>
                <span class="c1"># Expected to be con_cat_astro.npy, con_cat_photo.npy and magref.npy</span>
                <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">cat_folder_path</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                        <span class="n">chunk_size</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">getsize</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

            <span class="c1"># Append result as tuple of size, ID and all 3 paths</span>
            <span class="n">chunk_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">))</span>

        <span class="c1"># Sort chunk list by size, largest to smallest</span>
        <span class="n">chunk_queue</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Remove chunk size from output list</span>
        <span class="n">chunk_queue_sorted</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="n">chunk_id</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span> <span class="k">for</span>
                               <span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">chunk_id</span><span class="p">,</span> <span class="n">joint_file_path</span><span class="p">,</span> <span class="n">cat_a_file_path</span><span class="p">,</span> <span class="n">cat_b_file_path</span><span class="p">)</span> <span class="ow">in</span>
                               <span class="n">chunk_queue</span> <span class="p">]</span>

        <span class="k">return</span> <span class="n">chunk_queue_sorted</span>

    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Final clean up operations before application shut down</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resume_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_str2bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience function to convert strings to boolean values.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        v : string</span>
<span class="sd">            String entry to be converted to ``True`` or ``False``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        flag_val : boolean</span>
<span class="sd">            Boolean-converted value that ``v`` represents.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Boolean flag key not set to allowed value.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flag_val</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;yes&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">flag_val</span>

    <span class="k">def</span> <span class="nf">_make_regions_points</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_type</span><span class="p">,</span> <span class="n">region_frame</span><span class="p">,</span> <span class="n">region_points</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Wrapper function for the creation of &quot;region&quot; coordinate tuples,</span>
<span class="sd">        given either a set of rectangular points or a list of coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region_type : string</span>
<span class="sd">            String containing the kind of system the region pointings are in.</span>
<span class="sd">            Should be &quot;rectangle&quot;, regularly sampled points in the two sky</span>
<span class="sd">            coordinates, or &quot;points&quot;, individually specified sky coordinates.</span>
<span class="sd">        region_Frame : string</span>
<span class="sd">            String containing the coordinate system the points are in. Should</span>
<span class="sd">            be either &quot;equatorial&quot; or &quot;galactic&quot;.</span>
<span class="sd">        region_points : string</span>
<span class="sd">            String containing the evaluation points. If ``region_type`` is</span>
<span class="sd">            &quot;rectangle&quot;, should be six values, the start and stop values and</span>
<span class="sd">            number of entries of the respective sky coordinates; and if</span>
<span class="sd">            ``region_type`` is &quot;points&quot;, ``region_points`` should be tuples</span>
<span class="sd">            of the form ``(a, b)`` separated by whitespace.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">rt</span> <span class="o">=</span> <span class="n">region_type</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;rectangle&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">point</span><span class="p">)</span> <span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be 6 numbers separated &quot;</span>
                                 <span class="s2">&quot;by spaces.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of steps between start and stop values for &quot;</span>
                                     <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be integers.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">ax1_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                <span class="n">ax2_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">ax1_p</span><span class="p">,</span> <span class="n">ax2_p</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be 6 numbers separated &quot;</span>
                                 <span class="s2">&quot;by spaces.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="n">rt</span> <span class="o">==</span> <span class="s1">&#39;points&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;), )&#39;</span><span class="p">)</span>
                <span class="c1"># Remove the first ( and final ) that weren&#39;t split by &quot;), (&quot; -&gt; &quot;), )&quot;</span>
                <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">q</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
                <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be a list of &#39;(a, b), (c, d)&#39; tuples, &quot;</span>
                                 <span class="s2">&quot;separated by a comma.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should either be &#39;rectangle&#39; or &#39;points&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">region_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_points</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">points</span><span class="p">)</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rf</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span> <span class="ow">or</span> <span class="n">rf</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">region_frame</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should either be &#39;equatorial&#39; or &#39;galactic&#39;.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">region_frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<div class="viewcode-block" id="CrossMatch.read_metadata">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.read_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Helper function to read in metadata and set various class attributes.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">joint_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">joint_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">joint_config</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">cat_a_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_a_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cat_a_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">cat_a_config</span> <span class="o">=</span> <span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>
        <span class="n">cat_b_config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_b_file_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">cat_b_config</span><span class="o">.</span><span class="n">read_string</span><span class="p">(</span><span class="s1">&#39;[config]</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">cat_b_config</span> <span class="o">=</span> <span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;config&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;include_perturb_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;include_phot_like&#39;</span><span class="p">,</span> <span class="s1">&#39;use_phot_priors&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;cf_region_type&#39;</span><span class="p">,</span> <span class="s1">&#39;cf_region_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;cf_region_points&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;joint_folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;pos_corr_dist&#39;</span><span class="p">,</span> <span class="s1">&#39;real_hankel_points&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;four_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_max_rho&#39;</span><span class="p">,</span> <span class="s1">&#39;cross_match_extent&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;int_fracs&#39;</span><span class="p">,</span> <span class="s1">&#39;make_output_csv&#39;</span><span class="p">,</span> <span class="s1">&#39;n_pool&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from joint metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;auf_region_type&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_region_points&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;filt_names&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_name&#39;</span><span class="p">,</span> <span class="s1">&#39;auf_folder_path&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_folder_path&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;correct_astrometry&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">run_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;include_perturb_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;include_phot_like&#39;</span><span class="p">,</span> <span class="s1">&#39;use_phot_priors&#39;</span><span class="p">]:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_flag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="n">run_flag</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_regions_points</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_type&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_type&#39;</span><span class="p">]],</span>
                                      <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_frame&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_frame&#39;</span><span class="p">]],</span>
                                      <span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">auf_region_points&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                                       <span class="n">config</span><span class="p">[</span><span class="s1">&#39;auf_region_points&#39;</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_make_regions_points</span><span class="p">([</span><span class="s1">&#39;cf_region_type&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_type&#39;</span><span class="p">]],</span>
                                  <span class="p">[</span><span class="s1">&#39;cf_region_frame&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_frame&#39;</span><span class="p">]],</span>
                                  <span class="p">[</span><span class="s1">&#39;cf_region_points&#39;</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cf_region_points&#39;</span><span class="p">]])</span>

        <span class="c1"># If the frame of the two AUF parameter files and the &#39;cf&#39; frame are</span>
        <span class="c1"># not all the same then we have to raise an error.</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span> <span class="ow">or</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_frame</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Region frames for c/f and AUF creation must all be the same.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;joint_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;auf_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;auf_folder_path&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;cat_folder_path&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;cat_folder_path&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

        <span class="c1"># Only have to check for the existence of Pertubation AUF-related</span>
        <span class="c1"># parameters if we are using the perturbation AUF component.</span>
        <span class="c1"># However, calling AstrometricCorrections in its current form confuses</span>
        <span class="c1"># this, since it always uses the perturbation AUF component. We therefore</span>
        <span class="c1"># split out the items that are NOT required for AstrometricCorrections</span>
        <span class="c1"># first, if there are any.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;correct_astrometry&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;correct_astrometry&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;compute_snr_mag_relation&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;compute_snr_mag_relation&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ambiguity in catalogue &#39;a&#39; having both correct_astrometry and &quot;</span>
                             <span class="s2">&quot;compute_snr_mag_relation both being True. Only set at most one &quot;</span>
                             <span class="s2">&quot;flag as &#39;True&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ambiguity in catalogue &#39;b&#39; having both correct_astrometry and &quot;</span>
                             <span class="s2">&quot;compute_snr_mag_relation both being True. Only set at most one &quot;</span>
                             <span class="s2">&quot;flag as &#39;True&#39;.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;num_trials&#39;</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from joint metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">))</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;num_trials&#39;</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_trials should be an integer.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_trials should be an integer.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;d_mag&#39;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="n">flag</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> must be a float.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>

        <span class="c1"># Nominally these are all of the parameters required if include_perturb_auf</span>
        <span class="c1"># is True, but for the minute they&#39;re also forced if correct_astrometry</span>
        <span class="c1"># is also True instead of those aligning, so we bypass the if statement</span>
        <span class="c1"># if self.a_correct_astrometry or self.b_correct_astrometry respectively</span>
        <span class="c1"># have been set.</span>
        <span class="k">for</span> <span class="n">correct_astro</span><span class="p">,</span> <span class="n">compute_snr_mag_relation</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">],</span>
                <span class="p">[</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span> <span class="ow">or</span> <span class="n">correct_astro</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dens_dist&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">dens_dist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dens_dist&#39;</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dens_dist in catalogue </span><span class="si">{}</span><span class="s2"> must be a float.&quot;</span>
                                     <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">fit_gal_flag&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">]))</span>

            <span class="c1"># snr_mag_params_path is needed in any one of these three cases:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span> <span class="ow">or</span> <span class="n">correct_astro</span> <span class="ow">or</span> <span class="n">compute_snr_mag_relation</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;snr_mag_params_path&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;snr_mag_params_path&#39;</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">snr_mag_params_path does not exist. Please ensure that &#39;</span>
                                  <span class="s1">&#39;path for catalogue </span><span class="si">{}</span><span class="s1"> is correct.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="c1"># If we are correcting the astrometry, we will be</span>
                <span class="c1"># re-making the SNR-mag relations so skip loading, and hence</span>
                <span class="c1"># checking the existence of, that for now.</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">correct_astro</span> <span class="ow">or</span> <span class="n">compute_snr_mag_relation</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                          <span class="n">config</span><span class="p">[</span><span class="s1">&#39;snr_mag_params_path&#39;</span><span class="p">])):</span>
                        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;snr_mag_params file not found in catalogue &#39;</span>
                                                <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> path. Please ensure astrometry corrections &#39;</span>
                                                <span class="s1">&#39;are pre-generated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

                    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">config</span><span class="p">[</span><span class="s1">&#39;snr_mag_params_path&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span>
                            <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">)))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">snr_mag_params should be of shape (X, Y, 5).&#39;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">snr_mag_params&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">snr_mag_params_path&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;snr_mag_params_path&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span> <span class="ow">or</span> <span class="n">correct_astro</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">,</span> <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">,</span> <span class="s1">&#39;tri_filt_num&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;download_tri&#39;</span><span class="p">,</span> <span class="s1">&#39;psf_fwhms&#39;</span><span class="p">,</span> <span class="s1">&#39;run_fw_auf&#39;</span><span class="p">,</span> <span class="s1">&#39;run_psf_auf&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;tri_maglim_faint&#39;</span><span class="p">,</span> <span class="s1">&#39;tri_num_faint&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_al_avs&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="c1"># Set as a list of floats</span>
                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gal_al_avs&#39;</span><span class="p">]:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be a list of floats in catalogue &#39;</span>
                                         <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">filt_names should contain the same &#39;</span>
                                         <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">download_tri&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;download_tri&#39;</span><span class="p">]))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_set_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_set_name&#39;</span><span class="p">])</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_names and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;psf_fwhms should be a list of floats in catalogue </span><span class="si">{}</span><span class="s1"> &#39;</span>
                                     <span class="s1">&#39;metadata file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">psf_fwhms and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">psf_fwhms&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">run_fw_auf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;run_fw_auf&#39;</span><span class="p">]))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">run_psf_auf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;run_psf_auf&#39;</span><span class="p">]))</span>

                <span class="c1"># Only need dd_params or l_cut if we&#39;re using run_psf_auf or</span>
                <span class="c1"># correct_astrometry is True.</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">run_psf_auf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span> <span class="ow">or</span> <span class="n">correct_astro</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">check_flag</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dd_params_path&#39;</span><span class="p">,</span> <span class="s1">&#39;l_cut_path&#39;</span><span class="p">],</span>
                                             <span class="p">[</span><span class="s1">&#39;dd_params&#39;</span><span class="p">,</span> <span class="s1">&#39;l_cut&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span>
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                    <span class="k">for</span> <span class="n">check_flag</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;dd_params_path&#39;</span><span class="p">,</span> <span class="s1">&#39;l_cut_path&#39;</span><span class="p">],</span>
                                             <span class="p">[</span><span class="s1">&#39;dd_params&#39;</span><span class="p">,</span> <span class="s1">&#39;l_cut&#39;</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">check_flag</span><span class="p">]):</span>
                            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1"> does not exist. Please ensure that path for &#39;</span>
                                          <span class="s1">&#39;catalogue </span><span class="si">{}</span><span class="s1"> is correct.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">check_flag</span><span class="p">,</span>
                                                                            <span class="n">catname</span><span class="p">))</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">check_flag</span><span class="p">],</span> <span class="n">f</span><span class="p">)):</span>
                            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> file not found in catalogue </span><span class="si">{}</span><span class="s1"> path. &#39;</span>
                                                    <span class="s1">&#39;Please ensure PSF photometry perturbations &#39;</span>
                                                    <span class="s1">&#39;are pre-generated.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                        <span class="k">if</span> <span class="s1">&#39;dd_params&#39;</span> <span class="ow">in</span> <span class="n">check_flag</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/dd_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;dd_params_path&#39;</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">dd_params should be of shape (5, X, 2).&#39;</span>
                                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                        <span class="k">if</span> <span class="s1">&#39;l_cut&#39;</span> <span class="ow">in</span> <span class="n">check_flag</span><span class="p">:</span>
                            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/l_cut.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;l_cut_path&#39;</span><span class="p">]))</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">l_cut should be of shape (3,) only.&#39;</span>
                                                 <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="n">a</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_filt_num&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_filt_num&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_filt_num should be a single integer number in &quot;</span>
                                         <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_filt_num should be a single integer number in &quot;</span>
                                     <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

                <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;_faint&#39;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_num</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_num</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_num</span><span class="si">{}</span><span class="s2"> should be a single integer number in &quot;</span>
                                             <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_num</span><span class="si">{}</span><span class="s2"> should be a single integer number in &quot;</span>
                                         <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">tri_maglim</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">suffix</span><span class="p">),</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;tri_maglim</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]))</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;tri_maglim</span><span class="si">{}</span><span class="s2"> in catalogue </span><span class="si">{}</span><span class="s2"> must be a float.&quot;</span>
                                         <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">suffix</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">correct_astro</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">flag</span> <span class="o">==</span> <span class="s2">&quot;a_&quot;</span><span class="p">:</span>
                        <span class="n">fit_gal_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fit_gal_flag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span>
                <span class="k">if</span> <span class="n">correct_astro</span> <span class="ow">or</span> <span class="n">fit_gal_flag</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gal_wavs&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_nzs&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;gal_aboffsets&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_filternames&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span>
                                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                    <span class="c1"># Set all lists of floats</span>
                    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gal_wavs&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_zmax&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_aboffsets&#39;</span><span class="p">]:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> should be a list of floats in catalogue &#39;</span>
                                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">filt_names should contain the same &#39;</span>
                                             <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">var</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>
                    <span class="c1"># galaxy_nzs should be a list of integers.</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gal_nzs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;gal_nzs should be a list of integers &#39;</span>
                                         <span class="s1">&#39;in catalogue </span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_nzs and </span><span class="si">{}</span><span class="s1">filt_names should contain the same &#39;</span>
                                         <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">gal_nzs should be &#39;</span>
                                         <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_nzs&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>
                    <span class="c1"># Filter names are simple lists of strings</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;gal_filternames&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_filternames and </span><span class="si">{}</span><span class="s1">filt_names should contain the &#39;</span>
                                         <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">gal_filternames&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span> <span class="o">=</span> <span class="n">cat_a_config</span><span class="p">[</span><span class="s1">&#39;cat_name&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span> <span class="o">=</span> <span class="n">cat_b_config</span><span class="p">[</span><span class="s1">&#39;cat_name&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;pos_corr_dist&#39;</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pos_corr_dist must be a float.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;real_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_hankel_points&#39;</span><span class="p">,</span> <span class="s1">&#39;four_max_rho&#39;</span><span class="p">]:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="n">flag</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be an integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> should be an integer.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;cross_match_extent&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All elements of cross_match_extent should be floats.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cross_match_extent should contain four elements.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span> <span class="o">=</span> <span class="n">b</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;int_fracs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;All elements of int_fracs should be floats.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;int_fracs should contain three elements.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span> <span class="o">=</span> <span class="n">b</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_output_csv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;make_output_csv&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_output_csv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_metadata_csv</span><span class="p">(</span><span class="n">joint_config</span><span class="p">,</span> <span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">)</span>

        <span class="c1"># Load the multiprocessing Pool count.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;n_pool&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_pool should be a single integer number.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;n_pool should be a single integer number.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">correct_astro</span><span class="p">,</span> <span class="n">compute_snr_mag_relation</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_correct_astrometry</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_correct_astrometry</span><span class="p">],</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">a_compute_snr_mag_relation</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_compute_snr_mag_relation</span><span class="p">],</span>
                <span class="p">[</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="c1"># Have to split these parameters into two, as four of them are</span>
            <span class="c1"># required for the simpler case of just doing SNR-mag relation</span>
            <span class="c1"># calculations, instead of the full astrometry correction.</span>
            <span class="k">if</span> <span class="n">correct_astro</span> <span class="ow">or</span> <span class="n">compute_snr_mag_relation</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;correct_astro_save_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;csv_cat_file_string&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;pos_and_err_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_indices&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_unc_indices&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_astro_save_folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;correct_astro_save_folder&#39;</span><span class="p">]))</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">csv_cat_file_string&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;csv_cat_file_string&#39;</span><span class="p">]))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;mag_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mag_indices should be a list of integers &#39;</span>
                                     <span class="s1">&#39;in the catalogue </span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names and </span><span class="si">{}</span><span class="s1">mag_indices should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">mag_indices should be &#39;</span>
                                     <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">mag_indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;mag_unc_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;mag_unc_indices should be a list of integers &#39;</span>
                                     <span class="s1">&#39;in the catalogue </span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">mag_indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">mag_unc_indices and </span><span class="si">{}</span><span class="s1">mag_indices should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">mag_unc_indices should be &#39;</span>
                                     <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">mag_unc_indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

                <span class="c1"># pos_and_err_indices should be a three- or six-integer list that</span>
                <span class="c1"># we then transform into [reference_cat_inds, this_cat_inds]</span>
                <span class="c1"># where each *_cat_inds is a three-element list [x, y, z],</span>
                <span class="c1"># or just this_cat_inds in the case of</span>
                <span class="c1"># compute_snr_mag_relation=True.</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;pos_and_err_indices&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;pos_and_err_indices should be a list of integers &#39;</span>
                                     <span class="s1">&#39;in the catalogue </span><span class="si">{}</span><span class="s1"> metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">correct_astro</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">pos_and_err_indices should contain six elements &#39;</span>
                                     <span class="s1">&#39;when correct_astrometry is True.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">compute_snr_mag_relation</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">pos_and_err_indices should contain three elements &#39;</span>
                                     <span class="s1">&#39;when compute_snr_mag_relation is True.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">pos_and_err_indices should be &#39;</span>
                                     <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">correct_astro</span><span class="p">:</span>
                    <span class="c1"># The reshape puts the first three elements in a[0], and hence</span>
                    <span class="c1"># those are ref_cat_inds, with a[1] this_cat_inds.</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">pos_and_err_indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">d</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we only want to compute the SNR-mag relation, then we&#39;ve</span>
                    <span class="c1"># only got three elements, so we just store them in a (3,)</span>
                    <span class="c1"># shape array.</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">pos_and_err_indices&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">d</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">correct_astro</span><span class="p">:</span>
                <span class="c1"># If this particular catalogue requires a systematic correction</span>
                <span class="c1"># for astrometric biases from ensemble match distributions before</span>
                <span class="c1"># we can do a probability-based cross-match, then load some extra</span>
                <span class="c1"># pieces of information, over and above those already loaded</span>
                <span class="c1"># for just the SNR-mag case.</span>
                <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;best_mag_index&#39;</span><span class="p">,</span> <span class="s1">&#39;nn_radius&#39;</span><span class="p">,</span> <span class="s1">&#39;ref_csv_cat_file_string&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;correct_mag_array&#39;</span><span class="p">,</span> <span class="s1">&#39;correct_mag_slice&#39;</span><span class="p">,</span> <span class="s1">&#39;correct_sig_slice&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;chunk_overlap_col&#39;</span><span class="p">,</span> <span class="s1">&#39;best_mag_index_col&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;use_photometric_uncertainties&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">use_photometric_uncertainties&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;use_photometric_uncertainties&#39;</span><span class="p">]))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;best_mag_index&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;best_mag_index should be an integer in the catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;best_mag_index should be an integer in the catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">filt_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;best_mag_index cannot be a larger index than the list of &quot;</span>
                                     <span class="s2">&quot;filters in the catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">best_mag_index&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;best_mag_index_col&#39;</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;best_mag_index_col should be an integer in the catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;best_mag_index_col should be an integer in the catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">best_mag_index_col&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;chunk_overlap_col&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s2">&quot;None&quot;</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">chunk_overlap_col&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunk_overlap_col should be an integer in the &quot;</span>
                                         <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_integer</span><span class="p">():</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunk_overlap_col should be an integer in the &quot;</span>
                                         <span class="s2">&quot;catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">chunk_overlap_col&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">nn_radius&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;nn_radius&#39;</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;nn_radius must be a float in the catalogue </span><span class="si">{}</span><span class="s2"> &quot;</span>
                                     <span class="s2">&quot;metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>

                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">ref_csv_cat_file_string&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;ref_csv_cat_file_string&#39;</span><span class="p">]))</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;correct_mag_array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;correct_mag_array should be a list of floats in the &#39;</span>
                                     <span class="s1">&#39;catalogue </span><span class="si">{}</span><span class="s1"> metadata file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;correct_mag_slice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;correct_mag_slice should be a list of floats in the &#39;</span>
                                     <span class="s1">&#39;catalogue </span><span class="si">{}</span><span class="s1"> metadata file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_array and </span><span class="si">{}</span><span class="s1">correct_mag_slice should contain &#39;</span>
                                     <span class="s1">&#39;the same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_slice&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;correct_sig_slice&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;correct_sig_slice should be a list of floats in the &#39;</span>
                                     <span class="s1">&#39;catalogue </span><span class="si">{}</span><span class="s1"> metadata file.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_array&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_mag_array and </span><span class="si">{}</span><span class="s1">correct_sig_slice should contain &#39;</span>
                                     <span class="s1">&#39;the same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">,</span> <span class="n">flag</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">correct_sig_slice&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">flag</span><span class="p">),</span> <span class="n">b</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_read_metadata_csv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joint_config</span><span class="p">,</span> <span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read metadata from input config files relating to outputting combined</span>
<span class="sd">        .csv files during the post-process step, if requested.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        joint_config : ConfigParser</span>
<span class="sd">            The pre-loaded set of input configuration parameters as related</span>
<span class="sd">            to the joint match between catalogues a and b.</span>
<span class="sd">        cat_a_config : ConfigParser</span>
<span class="sd">            Configuration parameters that are solely related to catalogue &quot;a&quot;.</span>
<span class="sd">        cat_b_config : ConfigParser</span>
<span class="sd">            Configuration parameters that are just relate to catalogue &quot;b&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;output_csv_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;match_out_csv_name&#39;</span><span class="p">,</span> <span class="s1">&#39;nonmatch_out_csv_name&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">joint_config</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from joint metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">check_flag</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;&quot;a&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;&quot;b&quot;&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">check_flag</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;input_csv_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_csv_name&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_col_names&#39;</span><span class="p">,</span> <span class="s1">&#39;cat_col_nums&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;input_npy_folder&#39;</span><span class="p">,</span> <span class="s1">&#39;csv_has_header&#39;</span><span class="p">,</span> <span class="s1">&#39;extra_col_names&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;extra_col_nums&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">check_flag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Missing key </span><span class="si">{}</span><span class="s2"> from catalogue </span><span class="si">{}</span><span class="s2"> metadata file.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                     <span class="n">check_flag</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">output_csv_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;output_csv_folder&#39;</span><span class="p">])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_csv_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s2">&quot;Error when trying to create folder to store output csv files in. &quot;</span>
                          <span class="s2">&quot;Please ensure that output_csv_folder is correct in joint config file.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">match_out_csv_name</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;match_out_csv_name&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">config</span><span class="p">,</span> <span class="n">catname</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="n">cat_a_config</span><span class="p">,</span> <span class="n">cat_b_config</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span> <span class="s1">&#39;b_&#39;</span><span class="p">]):</span>
            <span class="c1"># Non-match csv name should be of the format</span>
            <span class="c1"># [cat name]_[some indication this is a non-match], but note that</span>
            <span class="c1"># this is defined in joint_config, not each individual</span>
            <span class="c1"># catalogue config!</span>
            <span class="n">nonmatch_out_name</span> <span class="o">=</span> <span class="n">joint_config</span><span class="p">[</span><span class="s1">&#39;nonmatch_out_csv_name&#39;</span><span class="p">]</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">nonmatch_out_csv_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">)),</span> <span class="n">nonmatch_out_name</span><span class="p">))</span>

            <span class="n">input_csv_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_csv_folder&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_csv_folder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;input_csv_folder from catalogue &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">input_csv_folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="n">input_csv_folder</span><span class="p">)</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_csv_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cat_csv_name&#39;</span><span class="p">])</span>

            <span class="c1"># cat_col_names is simply a list/array of strings. However, to</span>
            <span class="c1"># avoid any issues with generic names like &quot;RA&quot; being added to the</span>
            <span class="c1"># output .csv file twice, we prepend the catalogue name to the front</span>
            <span class="c1"># of them all.</span>
            <span class="n">catcolnames</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cat_col_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_col_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">)),</span>
                              <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">catcolnames</span><span class="p">]))</span>

            <span class="c1"># But cat_col_nums is a list/array of integers, and should be of the</span>
            <span class="c1"># same length as cat_col_names.</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;cat_col_nums&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cat_col_nums should be a list of integers &#39;</span>
                                 <span class="s1">&#39;in catalogue &quot;</span><span class="si">{}</span><span class="s1">&quot; metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_col_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_col_names and </span><span class="si">{}</span><span class="s1">cat_col_nums should contain the same &#39;</span>
                                 <span class="s1">&#39;number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">cat_col_nums should be &#39;</span>
                                 <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_col_nums&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

            <span class="n">input_npy_folder</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;input_npy_folder&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">input_npy_folder</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">input_npy_folder</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;input_npy_folder from catalogue &quot;</span><span class="si">{}</span><span class="s1">&quot; does not exist.&#39;</span>
                              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">input_npy_folder</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">input_npy_folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">input_npy_folder&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">input_npy_folder</span><span class="p">))</span>

            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">csv_has_header&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_str2bool</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;csv_has_header&#39;</span><span class="p">]))</span>

            <span class="c1"># As above, extra_col_names is just strings but extra_col_names</span>
            <span class="c1"># is a list of integers.</span>
            <span class="c1"># However, both can be None (although if either is None both have to</span>
            <span class="c1"># be None), so check for that first</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extra_col_names&#39;</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extra_col_nums&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_nums&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span> <span class="ow">or</span> <span class="n">a</span> <span class="o">!=</span> <span class="s1">&#39;None&#39;</span> <span class="ow">and</span> <span class="n">b</span> <span class="o">==</span> <span class="s1">&#39;None&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Both extra_col_names and extra_col_nums must be None if &#39;</span>
                                     <span class="s1">&#39;either is None in catalogue &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">catcolnames</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extra_col_names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">cat_name&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">)),</span>
                                  <span class="n">q</span><span class="p">)</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">catcolnames</span><span class="p">]))</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;extra_col_nums&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">a</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;extra_col_nums should be a list of integers &#39;</span>
                                     <span class="s1">&#39;in catalogue &quot;</span><span class="si">{}</span><span class="s1">&quot; metadata file&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_names&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_names and </span><span class="si">{}</span><span class="s1">extra_col_nums should contain the &#39;</span>
                                     <span class="s1">&#39;same number of entries.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">,</span> <span class="n">catname</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">is_integer</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;All elements of </span><span class="si">{}</span><span class="s1">extra_col_nums should be &#39;</span>
                                     <span class="s1">&#39;integers.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">))</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">extra_col_nums&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">catname</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">b</span><span class="p">]))</span>

<div class="viewcode-block" id="CrossMatch.make_shared_data">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.make_shared_data">[docs]</a>
    <span class="k">def</span> <span class="nf">make_shared_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to initialise the shared variables used in the cross-match process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">real_hankel_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_max_rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_hankel_points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>
        <span class="c1"># Only need to calculate these the first time we need them, so buffer for now.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="CrossMatch.create_perturb_auf">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.create_perturb_auf">[docs]</a>
    <span class="k">def</span> <span class="nf">create_perturb_auf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perturb_auf_func</span><span class="o">=</span><span class="n">make_perturb_aufs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function wrapping the main perturbation AUF component creation routines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        perturb_auf_func : callable, optional</span>
<span class="sd">            ``perturb_auf_func`` should create the perturbation AUF output files</span>
<span class="sd">            for each filter-pointing combination.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># Magnitude offsets corresponding to relative fluxes of perturbing sources; here</span>
        <span class="c1"># dm of 2.5 is 10% relative flux and dm = 5 corresponds to 1% relative flux. Used</span>
        <span class="c1"># to inform the fraction of simulations with a contaminant above these relative</span>
        <span class="c1"># fluxes.</span>
        <span class="c1"># TODO: allow as user input.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>

        <span class="c1"># TODO: allow as user input.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="c1"># See Wilson (2022, RNAAS, 6, 60) for the meanings of the variables c, m,</span>
        <span class="c1"># a, and u. For each of M*/phi*/alpha/P/Q, for blue+red galaxies, 2-4</span>
        <span class="c1"># variables are derived as a function of wavelength, or Q(P).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">24.286513</span><span class="p">,</span> <span class="mf">1.141760</span><span class="p">,</span> <span class="mf">2.655846</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">23.192520</span><span class="p">,</span> <span class="mf">1.778718</span><span class="p">,</span> <span class="mf">1.668292</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.001487</span><span class="p">,</span> <span class="mf">2.918841</span><span class="p">,</span> <span class="mf">0.000510</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">0.000560</span><span class="p">,</span> <span class="mf">7.691261</span><span class="p">,</span> <span class="mf">0.003330</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.065565</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.257761</span><span class="p">,</span> <span class="mf">0.021362</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.309077</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.067411</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.302018</span><span class="p">,</span> <span class="mf">0.034203</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.713062</span><span class="p">,</span> <span class="mf">0.233366</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.233627</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.322347</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">1.068926</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.385984</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.079</span><span class="p">,</span> <span class="mf">3.524</span><span class="p">,</span> <span class="mf">1.917</span><span class="p">,</span> <span class="mf">1.992</span><span class="p">,</span> <span class="mf">2.536</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.461</span><span class="p">,</span> <span class="mf">2.358</span><span class="p">,</span> <span class="mf">2.568</span><span class="p">,</span> <span class="mf">2.268</span><span class="p">,</span> <span class="mf">2.402</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.265</span><span class="p">,</span> <span class="mf">3.862</span><span class="p">,</span> <span class="mf">1.921</span><span class="p">,</span> <span class="mf">1.685</span><span class="p">,</span> <span class="mf">2.480</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.410</span><span class="p">,</span> <span class="mf">2.340</span><span class="p">,</span> <span class="mf">2.200</span><span class="p">,</span> <span class="mf">2.540</span><span class="p">,</span> <span class="mf">2.464</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">3.47e+09</span><span class="p">,</span> <span class="mf">3.31e+06</span><span class="p">,</span> <span class="mf">2.13e+09</span><span class="p">,</span> <span class="mf">1.64e+10</span><span class="p">,</span> <span class="mf">1.01e+09</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">3.84e+09</span><span class="p">,</span> <span class="mf">1.57e+06</span><span class="p">,</span> <span class="mf">3.91e+08</span><span class="p">,</span> <span class="mf">4.66e+10</span><span class="p">,</span> <span class="mf">3.03e+07</span><span class="p">]]</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">, chunk </span><span class="si">{}</span><span class="s1">: Creating empirical perturbation AUFs for catalogue &quot;a&quot;...&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">calc_j0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_psf_fwhms</span><span class="p">,</span> <span class="s1">&#39;tri_download_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_download_tri</span><span class="p">,</span>
                       <span class="s1">&#39;delta_mag_cuts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">,</span> <span class="s1">&#39;num_trials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span>
                       <span class="s1">&#39;j0s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span>
                       <span class="s1">&#39;density_radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dens_dist</span><span class="p">,</span>
                       <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_names</span><span class="p">,</span>
                       <span class="s1">&#39;run_fw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_run_fw_auf</span><span class="p">,</span> <span class="s1">&#39;run_psf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_run_psf_auf</span><span class="p">,</span>
                       <span class="s1">&#39;snr_mag_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_snr_mag_params</span><span class="p">,</span>
                       <span class="s1">&#39;tri_maglim_faint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_maglim_faint</span><span class="p">,</span>
                       <span class="s1">&#39;tri_num_faint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_num_faint</span><span class="p">,</span>
                       <span class="s1">&#39;tri_set_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_set_name</span><span class="p">,</span>
                       <span class="s1">&#39;tri_filt_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_tri_filt_num</span><span class="p">,</span>
                       <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_frame</span><span class="p">,</span>
                       <span class="s1">&#39;al_avs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_al_avs</span><span class="p">,</span> <span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_run_psf_auf</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;dd_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_params</span><span class="p">,</span>
                                           <span class="s1">&#39;l_cut&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_l_cut</span><span class="p">})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                               <span class="o">**</span><span class="p">{</span><span class="s1">&#39;cmau_array&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">,</span> <span class="s1">&#39;wavs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_wavs</span><span class="p">,</span>
                                  <span class="s1">&#39;z_maxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_zmax</span><span class="p">,</span> <span class="s1">&#39;nzs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_nzs</span><span class="p">,</span>
                                  <span class="s1">&#39;ab_offsets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_aboffsets</span><span class="p">,</span>
                                  <span class="s1">&#39;filter_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_gal_filternames</span><span class="p">,</span>
                                  <span class="s1">&#39;alpha0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span><span class="p">,</span> <span class="s1">&#39;alpha1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span><span class="p">,</span>
                                  <span class="s1">&#39;alpha_weight&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_fit_gal_flag</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_modelrefinds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_perturb_auf_outputs</span> <span class="o">=</span> <span class="n">perturb_auf_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">, chunk </span><span class="si">{}</span><span class="s1">: Creating empirical perturbation AUFs for catalogue &quot;b&quot;...&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">calc_j0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">:</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;psf_fwhms&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_psf_fwhms</span><span class="p">,</span> <span class="s1">&#39;tri_download_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_download_tri</span><span class="p">,</span>
                       <span class="s1">&#39;delta_mag_cuts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">,</span> <span class="s1">&#39;num_trials&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_trials</span><span class="p">,</span>
                       <span class="s1">&#39;j0s&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">,</span> <span class="s1">&#39;d_mag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">d_mag</span><span class="p">,</span>
                       <span class="s1">&#39;density_radius&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dens_dist</span><span class="p">,</span>
                       <span class="s1">&#39;tri_filt_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_names</span><span class="p">,</span>
                       <span class="s1">&#39;run_fw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_run_fw_auf</span><span class="p">,</span> <span class="s1">&#39;run_psf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_run_psf_auf</span><span class="p">,</span>
                       <span class="s1">&#39;snr_mag_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_snr_mag_params</span><span class="p">,</span>
                       <span class="s1">&#39;tri_maglim_faint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_maglim_faint</span><span class="p">,</span>
                       <span class="s1">&#39;tri_num_faint&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_num_faint</span><span class="p">,</span>
                       <span class="s1">&#39;tri_set_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_set_name</span><span class="p">,</span>
                       <span class="s1">&#39;tri_filt_num&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_tri_filt_num</span><span class="p">,</span>
                       <span class="s1">&#39;auf_region_frame&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_frame</span><span class="p">,</span>
                       <span class="s1">&#39;al_avs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_al_avs</span><span class="p">,</span> <span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_run_psf_auf</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;dd_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_dd_params</span><span class="p">,</span>
                                           <span class="s1">&#39;l_cut&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_l_cut</span><span class="p">})</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span>
                               <span class="o">**</span><span class="p">{</span><span class="s1">&#39;cmau_array&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">,</span> <span class="s1">&#39;wavs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_wavs</span><span class="p">,</span>
                                  <span class="s1">&#39;z_maxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_zmax</span><span class="p">,</span> <span class="s1">&#39;nzs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_nzs</span><span class="p">,</span>
                                  <span class="s1">&#39;ab_offsets&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_aboffsets</span><span class="p">,</span>
                                  <span class="s1">&#39;filter_names&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_gal_filternames</span><span class="p">,</span>
                                  <span class="s1">&#39;alpha0&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span><span class="p">,</span> <span class="s1">&#39;alpha1&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span><span class="p">,</span>
                                  <span class="s1">&#39;alpha_weight&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;fit_gal_flag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_fit_gal_flag</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_modelrefinds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_perturb_auf_outputs</span> <span class="o">=</span> <span class="n">perturb_auf_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_perturb_auf</span><span class="p">,</span> <span class="o">**</span><span class="n">_kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CrossMatch.group_sources">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.group_sources">[docs]</a>
    <span class="k">def</span> <span class="nf">group_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_func</span><span class="o">=</span><span class="n">make_island_groupings</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Function to handle the creation of catalogue &quot;islands&quot; and potential</span>
<span class="sd">        astrometrically related sources across the two catalogues.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_func : callable, optional</span>
<span class="sd">            ``group_func`` should create the various island- and overlap-related</span>
<span class="sd">            files by which objects across the two catalogues are assigned as</span>
<span class="sd">            potentially counterparts to one another.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">, chunk </span><span class="si">{}</span><span class="s1">: Creating catalogue islands and overlaps...&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span> <span class="o">=</span> <span class="n">gsf</span><span class="o">.</span><span class="n">calc_j1s</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -rf </span><span class="si">{}</span><span class="s1">/reject/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_sources_data</span> <span class="o">=</span> \
            <span class="n">group_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_modelrefinds</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">b_modelrefinds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">j1s</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_corr_dist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span><span class="p">,</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_perturb_auf_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_perturb_auf_outputs</span><span class="p">)</span></div>


<div class="viewcode-block" id="CrossMatch.calculate_phot_like">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.calculate_phot_like">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_phot_like</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phot_like_func</span><span class="o">=</span><span class="n">compute_photometric_likelihoods</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create the photometric likelihood information used in the cross-match</span>
<span class="sd">        process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phot_like_func : callable, optional</span>
<span class="sd">            The function that calls the overall computation of the counterpart</span>
<span class="sd">            and &quot;field&quot; star photometric likelihood-related information.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">, chunk </span><span class="si">{}</span><span class="s1">: Creating photometric priors and likelihoods...&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_cf_areas</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">:</span>
            <span class="n">bright_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">field_frac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_fracs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bright_frac</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">field_frac</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phot_like_data</span> <span class="o">=</span> <span class="n">phot_like_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_areas</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">include_phot_like</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_phot_priors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sources_data</span><span class="p">,</span> <span class="n">bright_frac</span><span class="p">,</span>
            <span class="n">field_frac</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_calculate_cf_areas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Convenience function to calculate the area around each</span>
<span class="sd">        ``cross_match_extent`` sky coordinate where it is defined as having the</span>
<span class="sd">        smallest on-sky separation.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Rank </span><span class="si">{}</span><span class="s2">, chunk </span><span class="si">{}</span><span class="s2">: Calculating photometric region areas...&quot;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">dlon</span><span class="p">,</span> <span class="n">dlat</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span>
        <span class="n">test_lons</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dlon</span><span class="p">)</span>
        <span class="n">test_lats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_match_extent</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dlat</span><span class="p">)</span>

        <span class="n">test_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">]</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">test_lons</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">test_lats</span><span class="p">])</span>

        <span class="n">inds</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">find_nearest_point</span><span class="p">(</span><span class="n">test_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">test_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">cf_areas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cf_region_points</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>

        <span class="c1"># Unit area of a sphere is cos(theta) dtheta dphi if theta goes from -90</span>
        <span class="c1"># to +90 degrees (sin(theta) for 0 to 180 degrees). Note, however, that</span>
        <span class="c1"># dtheta and dphi have to be in radians, so we have to convert the entire</span>
        <span class="c1"># thing from degrees and re-convert at the end. Hence:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inds</span><span class="p">):</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">test_coords</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">dtheta</span><span class="p">,</span> <span class="n">dphi</span> <span class="o">=</span> <span class="n">dlat</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">dlon</span> <span class="o">/</span> <span class="mi">180</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="c1"># Remember to convert back to square degrees:</span>
            <span class="n">cf_areas</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtheta</span> <span class="o">*</span> <span class="n">dphi</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cf_areas</span> <span class="o">=</span> <span class="n">cf_areas</span>

        <span class="k">return</span>

<div class="viewcode-block" id="CrossMatch.pair_sources">
<a class="viewcode-back" href="../../api/macauff.CrossMatch.html#macauff.CrossMatch.pair_sources">[docs]</a>
    <span class="k">def</span> <span class="nf">pair_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count_pair_func</span><span class="o">=</span><span class="n">source_pairing</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Assign sources in the two catalogues as either counterparts to one another</span>
<span class="sd">        or singly detected &quot;field&quot; sources.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        count_pair_func : callable, optional</span>
<span class="sd">            The function that calls the counterpart determination routine.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> Rank </span><span class="si">{}</span><span class="s1">, chunk </span><span class="si">{}</span><span class="s1">: Determining counterparts...&#39;</span>
              <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_id</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;rm -r </span><span class="si">{}</span><span class="s1">/pairing/*&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">))</span>
        <span class="n">count_pair_func</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">joint_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_folder_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_folder_path</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_filt_names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_auf_region_points</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_auf_region_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_modelrefinds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_modelrefinds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delta_mag_cuts</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_sources_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">phot_like_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_perturb_auf_outputs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_perturb_auf_outputs</span><span class="p">)</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.matching</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, Tom J Wilson.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>