<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>macauff.fit_astrometry &#8212; macauff</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=4848ba22" />
    <link rel="stylesheet" type="text/css" href="../../_static/pyramid.css?v=a5b9c134" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=eafc0fe6" />
    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.fit_astrometry</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for macauff.fit_astrometry</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a 3-clause BSD style license - see LICENSE</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Module for calculating corrections to astrometric uncertainties of photometric catalogues, by</span>
<span class="sd">fitting their AUFs and centroid uncertainties across ensembles of matches between well-understood</span>
<span class="sd">catalogue and one for which precisions are less well known.</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.lib.format</span> <span class="kn">import</span> <span class="n">open_memmap</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binned_statistic</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">import</span> <span class="nn">matplotlib.gridspec</span> <span class="k">as</span> <span class="nn">gridspec</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span><span class="p">,</span> <span class="n">Angle</span><span class="p">,</span> <span class="n">UnitSphericalRepresentation</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="c1"># Assume that usetex = False only applies for tests where no TeX is installed</span>
<span class="c1"># at all, instead of users having half-installed TeX, dvipng et al. somewhere.</span>
<span class="n">usetex</span> <span class="o">=</span> <span class="ow">not</span> <span class="ow">not</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;tex&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;text.usetex&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;text.latex.preamble&quot;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;\usepackage</span><span class="si">{amsmath}</span><span class="s2">&quot;</span><span class="p">})</span>

<span class="kn">from</span> <span class="nn">.galaxy_counts</span> <span class="kn">import</span> <span class="n">create_galaxy_counts</span>
<span class="kn">from</span> <span class="nn">.perturbation_auf</span> <span class="kn">import</span> <span class="p">(</span><span class="n">download_trilegal_simulation</span><span class="p">,</span> <span class="n">_calculate_magnitude_offsets</span><span class="p">,</span>
                               <span class="n">make_tri_counts</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.misc_functions</span> <span class="kn">import</span> <span class="n">min_max_lon</span>
<span class="kn">from</span> <span class="nn">.misc_functions_fortran</span> <span class="kn">import</span> <span class="n">misc_functions_fortran</span> <span class="k">as</span> <span class="n">mff</span>
<span class="kn">from</span> <span class="nn">.perturbation_auf_fortran</span> <span class="kn">import</span> <span class="n">perturbation_auf_fortran</span> <span class="k">as</span> <span class="n">paf</span>
<span class="kn">from</span> <span class="nn">.get_trilegal_wrapper</span> <span class="kn">import</span> <span class="n">get_AV_infinity</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;AstrometricCorrections&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="AstrometricCorrections">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections">[docs]</a>
<span class="k">class</span> <span class="nc">AstrometricCorrections</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to calculate any potential corrections to quoted astrometric</span>
<span class="sd">    precisions in photometric catalogues, based on reliable cross-matching</span>
<span class="sd">    to a well-understood second dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psf_fwhm</span><span class="p">,</span> <span class="n">numtrials</span><span class="p">,</span> <span class="n">nn_radius</span><span class="p">,</span> <span class="n">dens_search_radius</span><span class="p">,</span> <span class="n">save_folder</span><span class="p">,</span> <span class="n">trifolder</span><span class="p">,</span>
                 <span class="n">triname</span><span class="p">,</span> <span class="n">maglim_f</span><span class="p">,</span> <span class="n">magnum</span><span class="p">,</span> <span class="n">tri_num_faint</span><span class="p">,</span> <span class="n">trifilterset</span><span class="p">,</span> <span class="n">trifiltname</span><span class="p">,</span>
                 <span class="n">gal_wav_micron</span><span class="p">,</span> <span class="n">gal_ab_offset</span><span class="p">,</span> <span class="n">gal_filtname</span><span class="p">,</span> <span class="n">gal_alav</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">dd_params</span><span class="p">,</span> <span class="n">l_cut</span><span class="p">,</span>
                 <span class="n">ax1_mids</span><span class="p">,</span> <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="n">mag_array</span><span class="p">,</span> <span class="n">mag_slice</span><span class="p">,</span> <span class="n">sig_slice</span><span class="p">,</span> <span class="n">n_pool</span><span class="p">,</span>
                 <span class="n">npy_or_csv</span><span class="p">,</span> <span class="n">coord_or_chunk</span><span class="p">,</span> <span class="n">pos_and_err_indices</span><span class="p">,</span> <span class="n">mag_indices</span><span class="p">,</span> <span class="n">mag_unc_indices</span><span class="p">,</span>
                 <span class="n">mag_names</span><span class="p">,</span> <span class="n">best_mag_index</span><span class="p">,</span> <span class="n">coord_system</span><span class="p">,</span> <span class="n">pregenerate_cutouts</span><span class="p">,</span>
                 <span class="n">use_photometric_uncertainties</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cutout_area</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cutout_height</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">single_sided_auf</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of AstrometricCorrections, accepting inputs required for</span>
<span class="sd">        the running of the optimisation and parameterisation of astrometry of</span>
<span class="sd">        a photometric catalogue, benchmarked against a catalogue of much higher</span>
<span class="sd">        astrometric resolution and precision, such as Gaia or the Hubble Source</span>
<span class="sd">        Catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        psf_fwhm : float</span>
<span class="sd">            The full-width at half-maximum of the Point Spread Function, used to</span>
<span class="sd">            determine the size of the PSF for perturber placement purposes.</span>
<span class="sd">        numtrials : integer</span>
<span class="sd">            Number of simulations to run when deriving pertubation statistics.</span>
<span class="sd">        nn_radius : float</span>
<span class="sd">            Size of nearest-neighbour search for construction of intermediate</span>
<span class="sd">            cross-match distributions, in arcseconds.</span>
<span class="sd">        dens_search_radius : float</span>
<span class="sd">            Radius out to which to search around objects internal to a</span>
<span class="sd">            catalogue, to determine the local normalising density for each</span>
<span class="sd">            source, in degrees.</span>
<span class="sd">        save_folder : string</span>
<span class="sd">            Absolute or relative filepath of folder into which to store</span>
<span class="sd">            temporary and generated outputs from the fitting process.</span>
<span class="sd">        trifolder : string</span>
<span class="sd">            Filepath of the location into which to save TRILEGAL simulations.</span>
<span class="sd">        triname : string</span>
<span class="sd">            Name to give TRILEGAL simulations when downloaded. Is required to have</span>
<span class="sd">            two format ``{}`` options in string, for unique ax1-ax2 sightline</span>
<span class="sd">            combination downloads. Should not contain any file types, just the</span>
<span class="sd">            name of the file up to, but not including, the final &quot;.&quot;.</span>
<span class="sd">        maglim_f : float</span>
<span class="sd">            Magnitude in the ``magnum`` filter down to which sources should be</span>
<span class="sd">            drawn for the &quot;faint&quot; sample.</span>
<span class="sd">        magnum : float</span>
<span class="sd">            Zero-indexed column number of the chosen filter limiting magnitude.</span>
<span class="sd">        tri_num_faint : integer</span>
<span class="sd">            Approximate number of objects to simulate in the chosen filter for</span>
<span class="sd">            TRILEGAL simulations.</span>
<span class="sd">        trifilterset : string</span>
<span class="sd">            Name of the TRILEGAL filter set for which to generate simulations.</span>
<span class="sd">        trifiltname : string</span>
<span class="sd">            Name of the specific filter to generate perturbation AUF component in.</span>
<span class="sd">        gal_wav_micron : float</span>
<span class="sd">            Wavelength, in microns, of the ``trifiltname`` filter, for use in</span>
<span class="sd">            simulating galaxy counts.</span>
<span class="sd">        gal_ab_offset : float</span>
<span class="sd">            The offset between the ``trifiltname`` filter zero point and the</span>
<span class="sd">            AB magnitude offset.</span>
<span class="sd">        gal_filtname : string</span>
<span class="sd">            Name of the filter in the ``speclite`` compound naming convention.</span>
<span class="sd">        gal_alav : float</span>
<span class="sd">            Differential reddening vector of the given filter.</span>
<span class="sd">        dm : float</span>
<span class="sd">            Bin spacing for magnitude histograms of TRILEGAL simulations.</span>
<span class="sd">        dd_params : numpy.ndarray</span>
<span class="sd">            Array, of shape ``(5, X, 2)``, containing the parameterisation of</span>
<span class="sd">            the skew-normal used to construct background-dominated PSF</span>
<span class="sd">            perturbations.</span>
<span class="sd">        l_cut : numpy.ndarray</span>
<span class="sd">            Array of shape ``(3,)`` containing the cuts between the different</span>
<span class="sd">            regimes of background-dominated PSF perturbation.</span>
<span class="sd">        ax1_mids : numpy.ndarray</span>
<span class="sd">            Array of longitudes (e.g. RA or l) used to center regions used to</span>
<span class="sd">            determine astrometric corrections across the sky. Depending on</span>
<span class="sd">            ``ax_correction``, either the unique values that with ``ax2_mids``</span>
<span class="sd">            form a rectangle, or a unique ax-ax combination with a corresponding</span>
<span class="sd">            ``ax2_mid``.</span>
<span class="sd">        ax2_mids : numpy.ndarray</span>
<span class="sd">            Array of latitudes (Dec/b) defining regions for calculating</span>
<span class="sd">            astrometric corrections. Either unique rectangle values to combine</span>
<span class="sd">            with ``ax1_mids`` or unique ``ax1_mids``-``ax2_mids`` pairs, one</span>
<span class="sd">            per entry.</span>
<span class="sd">        ax_dimension : integer, either ``1`` or ``2``</span>
<span class="sd">            If ``1`` then ``ax1_mids`` and ``ax2_mids`` form unique sides of a</span>
<span class="sd">            rectangle when combined in a grid, or if ``2`` each</span>
<span class="sd">            ``ax1_mids``-``ax2_mids`` combination is a unique ax-ax pairing used</span>
<span class="sd">            as given.</span>
<span class="sd">        mag_array : numpy.ndarray</span>
<span class="sd">            List of magnitudes in the ``trifiltname`` filter to derive astrometry</span>
<span class="sd">            for.</span>
<span class="sd">        mag_slice : numpy.ndarray</span>
<span class="sd">            Widths of interval at which to take slices of magnitudes for deriving</span>
<span class="sd">            astrometric properties. Each ``mag_slice`` maps elementwise to each</span>
<span class="sd">            ``mag_array``, and hence they should be the same shape.</span>
<span class="sd">        sig_slice : numpy.ndarray</span>
<span class="sd">            Interval widths of quoted astrometric uncertainty to use when</span>
<span class="sd">            isolating individual sets of objects for AUF derivation. Length</span>
<span class="sd">            should match ``mag_array``.</span>
<span class="sd">        n_pool : integer</span>
<span class="sd">            The maximum number of threads to use when calling</span>
<span class="sd">            ``multiprocessing``.</span>
<span class="sd">        npy_or_csv : string, either ``npy`` or ``csv``</span>
<span class="sd">            Indicator as to whether the small chunks of sky to be loaded for</span>
<span class="sd">            each sightline&#39;s evaluation are in binary ``numpy`` format or saved</span>
<span class="sd">            to disk as a comma-separated values file.</span>
<span class="sd">        coord_or_chunk : string, either ``coord`` or ``chunk``</span>
<span class="sd">            String indicating whether intermediate files should be saved with</span>
<span class="sd">            filenames that are unique by two coordinates (l/b or RA/Dec) or</span>
<span class="sd">            some kind of singular &quot;chunk&quot; number. Output filenames would then</span>
<span class="sd">            need to follow ``&#39;file_{}{}&#39;`` or ``&#39;file_{}&#39;`` formatting</span>
<span class="sd">            respectively.</span>
<span class="sd">        pos_and_err_indices : list of list or numpy.ndarray of integers</span>
<span class="sd">            In order, the indices within catalogue &quot;a&quot; and then &quot;b&quot; respecetively</span>
<span class="sd">            of either the .npy or .csv file of the longitudinal (e.g. RA or l),</span>
<span class="sd">            latitudinal (Dec or b), and *singular*, circular astrometric</span>
<span class="sd">            precision array. Coordinates should be in degrees while precision</span>
<span class="sd">            should be in the same units as ``sig_slice`` and those of the</span>
<span class="sd">            nearest-neighbour distances, likely arcseconds. For example,</span>
<span class="sd">            ``[[0, 1, 2], [6, 3, 0]]`` where catalogue &quot;a&quot; has its coordinates</span>
<span class="sd">            in the first three columns in RA/Dec/Err order, while catalogue &quot;b&quot;</span>
<span class="sd">            has its coordinates in a more random order.</span>
<span class="sd">        mag_indices : list or numpy.ndarray</span>
<span class="sd">            In appropriate order, as expected by e.g. `~macauff.CrossMatch` inputs</span>
<span class="sd">            and `~macauff.make_perturb_aufs`, list the indexes of each magnitude</span>
<span class="sd">            column within either the ``.npy`` or ``.csv`` file loaded for each</span>
<span class="sd">            sub-catalogue sightline. These should be zero-indexed.</span>
<span class="sd">        mag_unc_indices : list or numpy.ndarray</span>
<span class="sd">            For each ``mag_indices`` entry, the corresponding magnitude</span>
<span class="sd">            uncertainty index in the catalogue.</span>
<span class="sd">        mag_names : list or numpy.ndarray of strings</span>
<span class="sd">            Names of each ``mag_indices`` magnitude.</span>
<span class="sd">        best_mag_index : integer</span>
<span class="sd">            Index into ``mag_indices`` of the preferred magnitude to use to</span>
<span class="sd">            construct astrometric scaling relations from. Should generally</span>
<span class="sd">            be the one with the most coverage across all detections in a</span>
<span class="sd">            catalogue, or the one with the most precise fluxes.</span>
<span class="sd">        coord_system : string, &quot;equatorial&quot; or &quot;galactic&quot;</span>
<span class="sd">            Identifier of which coordinate system the data are in. Both datasets</span>
<span class="sd">            must be in the same system, which can either be RA/Dec (equatorial)</span>
<span class="sd">            or l/b (galactic) coordinates.</span>
<span class="sd">        pregenerate_cutouts : boolean</span>
<span class="sd">            Indicates whether sightline catalogues must have been pre-made,</span>
<span class="sd">            or whether they can be generated by ``AstrometricCorrections``</span>
<span class="sd">            using specified lines-of-sight and cutout areas and heights.</span>
<span class="sd">        use_photometric_uncertainties : boolean, optional</span>
<span class="sd">            Flag for whether or not to use the photometric uncertainties instead</span>
<span class="sd">            of astrometric uncertainties when deriving astrometric uncertainties</span>
<span class="sd">            as a function of input precision. Defaults to False (use astrometric</span>
<span class="sd">            uncertainties).</span>
<span class="sd">        cutout_area : float, optional</span>
<span class="sd">            The size, in square degrees, of the regions used to simulate</span>
<span class="sd">            AUFs and determine astrometric corrections. Required if</span>
<span class="sd">            ``pregenerate_cutouts`` is ``False``.</span>
<span class="sd">        cutout_height : float, optional</span>
<span class="sd">            The latitudinal height of the rectangular regions used in</span>
<span class="sd">            calculating astrometric corrections. Required if</span>
<span class="sd">            ``pregenerate_cutouts`` is ``False``.</span>
<span class="sd">        single_sided_auf : boolean, optional</span>
<span class="sd">            Flag indicating whether the AUF of catalogue &quot;a&quot; can be ignored</span>
<span class="sd">            when considering match statistics, or if astrometric corrections</span>
<span class="sd">            are being constructed from matches to a catalogue that also suffers</span>
<span class="sd">            significant non-noise-based astrometric uncertainty.</span>
<span class="sd">        chunks = list or numpy.ndarray of strings, optional</span>
<span class="sd">            List of IDs for each unique set of data if ``coord_or_chunk`` is</span>
<span class="sd">            ``chunk``. In this case, ``ax_dimension`` must be ``2`` and each</span>
<span class="sd">            ``chunk`` must correspond to its ``ax1_mids``-``ax2_mids`` coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">single_sided_auf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;single_sided_auf must be True.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax_dimension must either be &#39;1&#39; or &#39;2&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npy_or_csv</span> <span class="o">!=</span> <span class="s2">&quot;npy&quot;</span> <span class="ow">and</span> <span class="n">npy_or_csv</span> <span class="o">!=</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;npy_or_csv must either be &#39;npy&#39; or &#39;csv&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">!=</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">and</span> <span class="n">coord_or_chunk</span> <span class="o">!=</span> <span class="s2">&quot;chunk&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord_or_chunk must either be &#39;coord&#39; or &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunks must be provided if coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax_dimension must be 2, and ax1-ax2 pairings provided for each chunk &quot;</span>
                             <span class="s2">&quot;in chunks if coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax1_mids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="ow">or</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="n">ax2_mids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax1_mids, ax2_mids, and chunks must all be the same length if &quot;</span>
                             <span class="s2">&quot;coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s2">&quot;equatorial&quot;</span> <span class="ow">or</span> <span class="n">coord_system</span> <span class="o">==</span> <span class="s2">&quot;galactic&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord_system must either be &#39;equatorial&#39; or &#39;galactic&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pregenerate_cutouts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">pregenerate_cutouts</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pregenerate_cutouts should either be &#39;True&#39; or &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pregenerate_cutouts</span> <span class="ow">and</span> <span class="n">cutout_area</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cutout_area must be given if pregenerate_cutouts is &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pregenerate_cutouts</span> <span class="ow">and</span> <span class="n">cutout_height</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cutout_height must be given if pregenerate_cutouts is &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_photometric_uncertainties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">use_photometric_uncertainties</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;use_photometric_uncertainties must either be True or False.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span> <span class="o">=</span> <span class="n">psf_fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span> <span class="o">=</span> <span class="n">numtrials</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nn_radius</span> <span class="o">=</span> <span class="n">nn_radius</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dens_search_radius</span> <span class="o">=</span> <span class="n">dens_search_radius</span>
        <span class="c1"># Currently hard-coded as it isn&#39;t useful for this work, but is required</span>
        <span class="c1"># for calling the perturbation AUF algorithms.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmcut</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="mf">1.185</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psfsig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psf_fwhm</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="mi">10000</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span> <span class="o">=</span> <span class="n">save_folder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span> <span class="o">=</span> <span class="n">trifolder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triname</span> <span class="o">=</span> <span class="n">triname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maglim_f</span> <span class="o">=</span> <span class="n">maglim_f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">magnum</span> <span class="o">=</span> <span class="n">magnum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tri_num_faint</span> <span class="o">=</span> <span class="n">tri_num_faint</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trifilterset</span> <span class="o">=</span> <span class="n">trifilterset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trifiltname</span> <span class="o">=</span> <span class="n">trifiltname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_wav_micron</span> <span class="o">=</span> <span class="n">gal_wav_micron</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_ab_offset</span> <span class="o">=</span> <span class="n">gal_ab_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_filtname</span> <span class="o">=</span> <span class="n">gal_filtname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alav</span> <span class="o">=</span> <span class="n">gal_alav</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dm</span> <span class="o">=</span> <span class="n">dm</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dd_params</span> <span class="o">=</span> <span class="n">dd_params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_cut</span> <span class="o">=</span> <span class="n">l_cut</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span> <span class="o">=</span> <span class="n">ax1_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span> <span class="o">=</span> <span class="n">ax2_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_dimension</span> <span class="o">=</span> <span class="n">ax_dimension</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span> <span class="o">=</span> <span class="n">pregenerate_cutouts</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutout_area</span> <span class="o">=</span> <span class="n">cutout_area</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutout_height</span> <span class="o">=</span> <span class="n">cutout_height</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mag_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mag_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mag_slice</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sig_slice</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">npy_or_csv</span> <span class="o">=</span> <span class="n">npy_or_csv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">=</span> <span class="n">coord_or_chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="n">coord_system</span>

        <span class="k">if</span> <span class="n">npy_or_csv</span> <span class="o">==</span> <span class="s1">&#39;npy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span> <span class="o">=</span> <span class="n">pos_and_err_indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span> <span class="o">=</span> <span class="n">mag_indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span> <span class="o">=</span> <span class="n">mag_unc_indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_names</span> <span class="o">=</span> <span class="n">mag_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span> <span class="o">=</span> <span class="n">best_mag_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># np.genfromtxt will load in pos_and_err or pos_and_err, mag_ind,</span>
            <span class="c1"># mag_unc_ind order for the two catalogues. Each will effectively</span>
            <span class="c1"># change its ordering, since we then load [0] for pos_and_err[0][0],</span>
            <span class="c1"># etc. for all options. These need saving for np.genfromtxt but</span>
            <span class="c1"># also for obtaining the correct column in the resulting sub-set of</span>
            <span class="c1"># the loaded csv file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mag_indices</span><span class="p">,</span> <span class="n">mag_unc_indices</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">mag_indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">mag_unc_indices</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mag_names</span> <span class="o">=</span> <span class="n">mag_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span> <span class="o">=</span> <span class="n">best_mag_index</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span> <span class="o">=</span> <span class="n">n_pool</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span> <span class="o">=</span> <span class="n">use_photometric_uncertainties</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span> <span class="o">=</span> <span class="n">mff</span><span class="o">.</span><span class="n">calc_j0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_mag_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_mag_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mag_cols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_cols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span>
                       <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

<div class="viewcode-block" id="AstrometricCorrections.__call__">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.__call__">[docs]</a>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a_cat_name</span><span class="p">,</span> <span class="n">b_cat_name</span><span class="p">,</span> <span class="n">a_cat_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">b_cat_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tri_download</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_summary_plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call function for the correction calculation process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a_cat_name : string</span>
<span class="sd">            Name of the catalogue &quot;a&quot; filename, pre-generated or saved by</span>
<span class="sd">            ``a_cat_func``. Must accept one or two formats via Python string</span>
<span class="sd">            formatting (e.g. ``&#39;a_string_{}&#39;``) that represent ``chunk``, or</span>
<span class="sd">            ``ax1_mid`` and ``ax2_mid``, depending on ``coord_or_chunk``.</span>
<span class="sd">        b_cat_name : string</span>
<span class="sd">            Name of the catalogue &quot;b&quot; filename. Must accept the same string</span>
<span class="sd">            formatting as ``a_cat_name``.</span>
<span class="sd">        a_cat_func : callable, optional</span>
<span class="sd">            Function used to generate reduced catalogue table for catalogue &quot;a&quot;.</span>
<span class="sd">            Must be given if ``pregenerate_cutouts`` is ``False``.</span>
<span class="sd">        b_cat_func : callable</span>
<span class="sd">            Function used to generate reduced catalogue table for catalogue &quot;b&quot;.</span>
<span class="sd">            Must be given if ``pregenerate_cutouts`` is ``False``.</span>
<span class="sd">        tri_download : boolean, optional</span>
<span class="sd">            Flag determining if TRILEGAL simulations should be re-downloaded</span>
<span class="sd">            if they already exist on disk.</span>
<span class="sd">        overwrite_all_sightlines : boolean, optional</span>
<span class="sd">            Flag for whether to create a totally fresh run of astrometric</span>
<span class="sd">            corrections, regardless of whether ``abc_array`` or ``m_sigs_array``</span>
<span class="sd">            are saved on disk. Defaults to ``False``.</span>
<span class="sd">        make_plots : boolean, optional</span>
<span class="sd">            Determines if intermediate figures are generated in the process</span>
<span class="sd">            of deriving astrometric corrections.</span>
<span class="sd">        make_summary_plot : boolean, optional</span>
<span class="sd">            If ``True`` then final summary plot is created, even if</span>
<span class="sd">            ``make_plots`` is ``False`` and intermediate plots are not created.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">a_cat_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;a_cat_func must be given if pregenerate_cutouts is &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">b_cat_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;b_cat_func must be given if pregenerate_cutouts is &#39;False&#39;.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_func</span> <span class="o">=</span> <span class="n">a_cat_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_func</span> <span class="o">=</span> <span class="n">b_cat_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span> <span class="o">=</span> <span class="n">a_cat_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span> <span class="o">=</span> <span class="n">b_cat_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tri_download</span> <span class="o">=</span> <span class="n">tri_download</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span> <span class="o">=</span> <span class="n">make_plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_summary_plot</span> <span class="o">=</span> <span class="n">make_summary_plot</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">make_ax_coords</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">make_catalogue_cutouts</span><span class="p">()</span>

        <span class="c1"># Making coords/cutouts happens for all sightlines, and then we</span>
        <span class="c1"># loop through each individually:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">overwrite_all_sightlines</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">))</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/m_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">))</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/n_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">))):</span>
            <span class="n">abc_array</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">m_sigs</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/m_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),))</span>
            <span class="n">m_sigs</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">n_sigs</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/n_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),))</span>
            <span class="n">n_sigs</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abc_array</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">m_sigs</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/m_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>
            <span class="n">n_sigs</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/n_sigs_array.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_summary_plot</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gridspec</span><span class="p">(</span><span class="s1">&#39;12312&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ylims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">999</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="s1">&#39;brown&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="p">,</span> <span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="s1">&#39;olive&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;cornflowerblue&#39;</span><span class="p">,</span> <span class="s1">&#39;deeppink&#39;</span><span class="p">,</span> <span class="s1">&#39;maroon&#39;</span><span class="p">,</span> <span class="s1">&#39;palevioletred&#39;</span><span class="p">,</span> <span class="s1">&#39;teal&#39;</span><span class="p">,</span> <span class="s1">&#39;crimson&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;chocolate&#39;</span><span class="p">,</span> <span class="s1">&#39;darksalmon&#39;</span><span class="p">,</span> <span class="s1">&#39;steelblue&#39;</span><span class="p">,</span> <span class="s1">&#39;slateblue&#39;</span><span class="p">,</span> <span class="s1">&#39;tan&#39;</span><span class="p">,</span> <span class="s1">&#39;yellowgreen&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;silver&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">index_</span><span class="p">,</span> <span class="n">list_of_things</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">zip_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">m_sigs</span><span class="p">[</span><span class="n">index_</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">n_sigs</span><span class="p">[</span><span class="n">index_</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running astrometry fits for sightline </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">index_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">list_of_things</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">list_of_things</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span> <span class="o">=</span> <span class="n">list_of_things</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_args</span> <span class="o">=</span> <span class="n">cat_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_catalogue</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_args</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_catalogue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_args</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_snr_model</span><span class="p">()</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1_mid</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2_mid</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">make_star_galaxy_counts</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">plot_star_galaxy_counts</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_local_densities_and_nearest_neighbours</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulate_aufs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_auf_pdfs</span><span class="p">()</span>
            <span class="n">m_sig</span><span class="p">,</span> <span class="n">n_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_uncertainty</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_fits_calculate_chi_sq</span><span class="p">()</span>
            <span class="n">m_sigs</span><span class="p">[</span><span class="n">index_</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_sig</span>
            <span class="n">n_sigs</span><span class="p">[</span><span class="n">index_</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_sig</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_summary_plot</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;12312&#39;</span><span class="p">)</span>
                <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">[</span><span class="n">index_</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols</span><span class="p">)]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avg_sig</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">skip_flags</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                   <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">m_sigs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sigs</span> <span class="o">=</span> <span class="n">m_sigs</span><span class="p">,</span> <span class="n">n_sigs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_summary_plot</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;12312&#39;</span><span class="p">)</span>
            <span class="n">x_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">100</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_array</span><span class="p">,</span> <span class="n">x_array</span><span class="p">,</span> <span class="s1">&#39;g:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">0.95</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.05</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input astrometric $\sigma$ / &quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input photometric $\sigma$ / &quot;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Fit astrometric $\sigma$ / &quot;&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input astrometric sigma / &quot;&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Input photometric sigma / &quot;&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax_b</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Fit astrometric sigma / &quot;&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finalise_summary_plot</span><span class="p">()</span></div>


<div class="viewcode-block" id="AstrometricCorrections.make_ax_coords">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.make_ax_coords">[docs]</a>
    <span class="k">def</span> <span class="nf">make_ax_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_b_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Derive the unique ax1-ax2 combinations used in fitting astrometry, and</span>
<span class="sd">        calculate corner coordinates based on the size of the box and its</span>
<span class="sd">        central coordinates.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>
<span class="sd">        check_b_only : boolean, optional</span>
<span class="sd">            Overloadable flag for cases where we can ignore catalogue &#39;a&#39; and</span>
<span class="sd">            only need to check for catalogue &#39;b&#39; existing if pregenerate_cutouts</span>
<span class="sd">            is True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If ax1 and ax2 are given as one-dimensional arrays, we need to</span>
        <span class="c1"># propagate those into two-dimensional grids first. Otherwise we</span>
        <span class="c1"># can skip this step.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1_grid_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids_</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax2_grid_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids_</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax1_grid_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ax2_grid_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_grid_length</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)</span>
        <span class="c1"># Force constant box height, but allow longitude to float to make sure</span>
        <span class="c1"># that we get good area coverage as the cos-delta factor increases</span>
        <span class="c1"># towards the poles.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span><span class="p">:</span>
            <span class="c1"># If we don&#39;t force pre-generated sightlines then we can generate</span>
            <span class="c1"># corners based on requested size and height, and latitude.</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2_mid</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">cutout_height</span><span class="o">/</span><span class="mi">2</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2_mid</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">cutout_height</span><span class="o">/</span><span class="mi">2</span>

                <span class="n">lat_integral</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="o">-</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

                <span class="k">if</span> <span class="mi">360</span> <span class="o">*</span> <span class="n">lat_integral</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutout_area</span><span class="p">:</span>
                    <span class="c1"># If sufficiently high in latitude, we ought to be able to take</span>
                    <span class="c1"># a full latitudinal slice around the entire sphere.</span>
                    <span class="n">delta_lon</span> <span class="o">=</span> <span class="mi">180</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">delta_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutout_area</span> <span class="o">/</span> <span class="n">lat_integral</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="c1"># Handle wrap-around longitude maths naively by forcing 0/360 as the</span>
                <span class="c1"># minimum/maximum allowed limits of each box.</span>
                <span class="c1"># TODO: once the rest of AstrometricCorrections handles the wraparound</span>
                <span class="c1"># logic, relax this requirement.</span>
                <span class="k">if</span> <span class="n">ax1_mid</span> <span class="o">-</span> <span class="n">delta_lon</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta_lon</span>
                <span class="k">elif</span> <span class="n">ax1_mid</span> <span class="o">+</span> <span class="n">delta_lon</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">360</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">delta_lon</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1_mid</span> <span class="o">-</span> <span class="n">delta_lon</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1_mid</span> <span class="o">+</span> <span class="n">delta_lon</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we&#39;ve definitely already made all of the cutouts, the corners</span>
            <span class="c1"># are preset.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">,)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">list_of_things</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">zip_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                    <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span> <span class="o">=</span> <span class="n">list_of_things</span>
                    <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">chunk</span><span class="p">,</span> <span class="o">=</span> <span class="n">list_of_things</span>
                    <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">check_b_only</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If pregenerate_cutouts is &#39;True&#39; all files must &quot;</span>
                                         <span class="s2">&quot;exist already, but </span><span class="si">{}</span><span class="s2"> does not.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If pregenerate_cutouts is &#39;True&#39; all files must &quot;</span>
                                     <span class="s2">&quot;exist already, but </span><span class="si">{}</span><span class="s2"> does not.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)))</span>
                <span class="c1"># Check for both files, but assume they are the same size</span>
                <span class="c1"># for ax1_min et al. purposes.</span>
                <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_catalogue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">cat_args</span><span class="p">)</span>
                <span class="c1"># Handle &quot;minimum&quot; longitude on the interval [-pi, +pi], such that</span>
                <span class="c1"># if data straddles the 0-360 boundary we don&#39;t return 0 and 360</span>
                <span class="c1"># for min and max values.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_max_lon</span><span class="p">(</span>
                    <span class="n">b</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>

        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/ax1_mids.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/ax2_mids.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstrometricCorrections.make_catalogue_cutouts">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.make_catalogue_cutouts">[docs]</a>
    <span class="k">def</span> <span class="nf">make_catalogue_cutouts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate cutout catalogues for regions as defined by corner ax1-ax2</span>
<span class="sd">        coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index_</span><span class="p">,</span> <span class="n">list_of_things</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">zip_list</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating catalogue cutouts... </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)),</span>
                  <span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="n">list_of_things</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">chunk</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="n">list_of_things</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">a_cat_func</span><span class="p">(</span><span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="o">*</span><span class="n">cat_args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">cat_args</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_func</span><span class="p">(</span><span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="o">*</span><span class="n">cat_args</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AstrometricCorrections.make_snr_model">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.make_snr_model">[docs]</a>
    <span class="k">def</span> <span class="nf">make_snr_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the relationship between source magnitude and its typical</span>
<span class="sd">        signal-to-noise ratio, based on the ensemble scaling relations of a</span>
<span class="sd">        given region.</span>

<span class="sd">        We treat SNR as being related to flux S with</span>
<span class="sd">        :math:`\frac{S}{\sqrt{cS + b + (aS)^2}}`, with ``a``, ``b``, and ``c``</span>
<span class="sd">        setting the scaling with systematic uncertainty, background flux,</span>
<span class="sd">        and photon noise respectively. We then use</span>
<span class="sd">        :math:`S = 10^{-M/2.5}`, and hence typical magnitude-SNR</span>
<span class="sd">        relations are completely described by ``a``, ``b``, and ``c``.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Making SNR model...&quot;</span><span class="p">)</span>
        <span class="n">a_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">b_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">c_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
            <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gridspec</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_cols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_rows</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">)):</span>
            <span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">s_bins</span><span class="p">,</span> <span class="n">s_d_snr_med</span><span class="p">,</span>
             <span class="n">s_d_snr_dmed</span><span class="p">,</span> <span class="n">snr_med</span><span class="p">,</span> <span class="n">snr_dmed</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_snr_model</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">res</span><span class="o">.</span><span class="n">x</span>
            <span class="n">a_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span>
            <span class="n">b_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">c_array</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s_d_snr_med</span><span class="p">)</span>
                <span class="n">_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">s_bins</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s_bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">10000</span><span class="p">)</span>

                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">_x</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span>
                        <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="n">s_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">s_bins</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">],</span> <span class="n">s_d_snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;k.&#39;</span><span class="p">,</span>
                            <span class="n">yerr</span><span class="o">=</span><span class="n">s_d_snr_dmed</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

                <span class="n">ax1_name</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;RA&#39;</span>
                <span class="n">ax2_name</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;Dec&#39;</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="se">\n</span><span class="s1">a = </span><span class="si">{:.2e}</span><span class="s1">, b = </span><span class="si">{:.2e}</span><span class="s1">, c = </span><span class="si">{:.2e}</span><span class="s1">&#39;</span>
                             <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_name</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_name</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_names</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
                                     <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">),</span>
                             <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">$(S)&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">$(S / SNR)&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;log10(S)&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log10(S / SNR)&#39;</span><span class="p">)</span>

                <span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="n">s_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">s_bins</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">],</span> <span class="n">snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;b.&#39;</span><span class="p">,</span>
                             <span class="n">yerr</span><span class="o">=</span><span class="n">snr_dmed</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">_x</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">_x</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span>
                         <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">$(SNR)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log10(SNR)&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf/s_vs_snr_</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">a_array</span><span class="p">,</span> <span class="n">b_array</span><span class="p">,</span> <span class="n">c_array</span></div>


<div class="viewcode-block" id="AstrometricCorrections.make_gridspec">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.make_gridspec">[docs]</a>
    <span class="k">def</span> <span class="nf">make_gridspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to generate a matplotlib canvas and populate it</span>
<span class="sd">        with a gridspec grid.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : string</span>
<span class="sd">            Unique identifier for the figure returned.</span>
<span class="sd">        y : int</span>
<span class="sd">            Number of rows in the resulting grid of axes.</span>
<span class="sd">        x : int</span>
<span class="sd">            Number of columns in the figure grid.</span>
<span class="sd">        ratio : float</span>
<span class="sd">            Aspect ratio of axis, with ``0.5`` being half as tall as it is</span>
<span class="sd">            wide.</span>
<span class="sd">        z : float</span>
<span class="sd">            Width of a single axis in real figure units, likely inches.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        gs : ~`matplotlib.gridspec.GridSpec`</span>
<span class="sd">            The created gridspec instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">*</span><span class="n">ratio</span><span class="o">*</span><span class="n">y</span><span class="p">))</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">gs</span></div>


<div class="viewcode-block" id="AstrometricCorrections.fit_snr_model">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.fit_snr_model">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_snr_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to derive the scaling relation between magnitude via flux</span>
<span class="sd">        and SNR.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        j : integer</span>
<span class="sd">            Index into ``self.mag_indices``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        res : ~scipy.optimize.OptimizeResult`</span>
<span class="sd">            Contains the results of the minimisation, as determined by `scipy`.</span>
<span class="sd">        s_bins : numpy.ndarray</span>
<span class="sd">            Log-flux bins used to construct ``s_d_snr_med`` and ``snr_med``.</span>
<span class="sd">        s_d_snr_med : numpy.ndarray</span>
<span class="sd">            Median ratio of flux to signal-to-noise ratio in each ``s_bins``</span>
<span class="sd">            bin.</span>
<span class="sd">        s_d_snr_dmed : numpy.ndarray</span>
<span class="sd">            Standard deviation of S/SNR in each ``s_bins`` bin.</span>
<span class="sd">        snr_med : numpy.ndarray</span>
<span class="sd">            Median SNR for each ``s_bins`` bin.</span>
<span class="sd">        snr_dmed : numpy.ndarray</span>
<span class="sd">            Standard deviation of SNR for all objects in a given ``s_bins`` bin.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">fit_snr_sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Minimisation function for determining magnitude-SNR scaling.</span>

<span class="sd">            Determined via log:math:`_{10}`(S/SNR), through a standard</span>
<span class="sd">            least-squares function and its derivatives with respect to</span>
<span class="sd">            ``a``, ``b``, and ``c``.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            p : list</span>
<span class="sd">                Contains the current minimisation iteration values of</span>
<span class="sd">                ``a``, ``b``, and ``c``.</span>
<span class="sd">            x : numpy.ndarray</span>
<span class="sd">                Array of log-flux values.</span>
<span class="sd">            y : numpy.ndarray</span>
<span class="sd">                Array of log-&quot;noise&quot; values, log:math:`_{10}`(S/SNR).</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            numpy.ndarray</span>
<span class="sd">                The least-squares sum of the data-model residuals, and</span>
<span class="sd">                their derivative with respect to each component in ``p``.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span>
            <span class="n">g</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">x</span> <span class="o">+</span> <span class="mi">10</span><span class="o">**</span><span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">a</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="p">))</span>
            <span class="n">dfdg</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">dgda</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
            <span class="n">dgdb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">b</span>
            <span class="n">dgdc</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">dfda</span> <span class="o">=</span> <span class="n">dgda</span> <span class="o">*</span> <span class="n">dfdg</span>
            <span class="n">dfdb</span> <span class="o">=</span> <span class="n">dgdb</span> <span class="o">*</span> <span class="n">dfdg</span>
            <span class="n">dfdc</span> <span class="o">=</span> <span class="n">dgdc</span> <span class="o">*</span> <span class="n">dfdg</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">f</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span>
                                                 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="n">dfda</span><span class="p">,</span> <span class="n">dfdb</span><span class="p">,</span> <span class="n">dfdc</span><span class="p">]])</span>

        <span class="n">s</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]])</span>
        <span class="c1"># Based on a naive dm = 2.5 log10((S+N)/S).</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">snr</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
        <span class="n">s_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>
        <span class="n">s_d_snr_perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">snr</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">99.9</span><span class="p">])</span>
        <span class="n">q</span> <span class="o">=</span> <span class="p">((</span><span class="n">s</span> <span class="o">&gt;</span> <span class="n">s_perc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">s_perc</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">snr</span> <span class="o">&gt;</span> <span class="n">s_d_snr_perc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span>
             <span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">s_d_snr_perc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">snr</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">snr</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>

        <span class="n">s_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">)),</span> <span class="mi">400</span><span class="p">)</span>

        <span class="n">s_d_snr_med</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">snr</span><span class="p">),</span>
                                             <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">s_bins</span><span class="p">)</span>
        <span class="n">s_d_snr_dmed</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="o">/</span><span class="n">snr</span><span class="p">),</span>
                                              <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">s_bins</span><span class="p">)</span>

        <span class="n">snr_med</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span>
                                         <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">s_bins</span><span class="p">)</span>
        <span class="n">snr_dmed</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">snr</span><span class="p">),</span> <span class="n">statistic</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">s_bins</span><span class="p">)</span>

        <span class="n">q</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">s_d_snr_med</span><span class="p">)</span>

        <span class="c1"># Find initial guesses, based on [S/SNR](S) = sqrt(c * S + b + (a * S)^2)</span>
        <span class="c1"># or SNR(S) = S / sqrt(c * S + b + (a * S)^2).</span>
        <span class="c1"># First, get the systematic inverse-SNR, in the regime where a dominates</span>
        <span class="c1"># and SNR(S) ~ 1/a, but remember that parameters are passed as log10(a).</span>
        <span class="n">a_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="o">-</span><span class="mi">15</span><span class="p">:]))</span>
        <span class="c1"># Can also directly get b, the background noise term, from S/SNR in the</span>
        <span class="c1"># limit that S is small, and S/SNR ~ sqrt(b).</span>
        <span class="n">b_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="n">s_d_snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">][:</span><span class="mi">15</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Then take average of the difference between the a+b model and the full</span>
        <span class="c1"># model to get the photon-noise, sqrt(S)-scaling final parameter.</span>
        <span class="n">half_model</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">b_guess</span> <span class="o">+</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">a_guess</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">((</span><span class="n">s_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">s_bins</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">]))</span>
        <span class="c1"># If (S/SNR)^2 = c * S + b + (a * S)^2, then c ~ (S/SNR)^2 / half_model:</span>
        <span class="n">c_guess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="mi">10</span><span class="o">**</span><span class="n">s_d_snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">half_model</span><span class="p">))</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">fit_snr_sqrt</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">((</span><span class="n">s_bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">s_bins</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">],</span>
                       <span class="n">s_d_snr_med</span><span class="p">[</span><span class="n">q</span><span class="p">]),</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="n">a_guess</span><span class="p">,</span> <span class="n">b_guess</span><span class="p">,</span> <span class="n">c_guess</span><span class="p">],</span> <span class="n">jac</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">s_bins</span><span class="p">,</span> <span class="n">s_d_snr_med</span><span class="p">,</span> <span class="n">s_d_snr_dmed</span><span class="p">,</span> <span class="n">snr_med</span><span class="p">,</span> <span class="n">snr_dmed</span></div>


<div class="viewcode-block" id="AstrometricCorrections.make_star_galaxy_counts">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.make_star_galaxy_counts">[docs]</a>
    <span class="k">def</span> <span class="nf">make_star_galaxy_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate differential source counts for each cutout region, simulating</span>
<span class="sd">        both stars and galaxies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: load from CrossMatch in some fashion to avoid errors from</span>
        <span class="c1"># updating one but not the other.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="c1"># See Wilson (2022, RNAAS, 6, 60) for the meanings of the variables c, m,</span>
        <span class="c1"># a, and u. For each of M*/phi*/alpha/P/Q, for blue+red galaxies, 2-4</span>
        <span class="c1"># variables are derived as a function of wavelength, or Q(P).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">24.286513</span><span class="p">,</span> <span class="mf">1.141760</span><span class="p">,</span> <span class="mf">2.655846</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">23.192520</span><span class="p">,</span> <span class="mf">1.778718</span><span class="p">,</span> <span class="mf">1.668292</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.001487</span><span class="p">,</span> <span class="mf">2.918841</span><span class="p">,</span> <span class="mf">0.000510</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">0.000560</span><span class="p">,</span> <span class="mf">7.691261</span><span class="p">,</span> <span class="mf">0.003330</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.065565</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">1.257761</span><span class="p">,</span> <span class="mf">0.021362</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.309077</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.067411</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.302018</span><span class="p">,</span> <span class="mf">0.034203</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mf">0.713062</span><span class="p">,</span> <span class="mf">0.233366</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.233627</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.322347</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">],</span>
                                        <span class="p">[</span><span class="mf">1.068926</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.385984</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.079</span><span class="p">,</span> <span class="mf">3.524</span><span class="p">,</span> <span class="mf">1.917</span><span class="p">,</span> <span class="mf">1.992</span><span class="p">,</span> <span class="mf">2.536</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.461</span><span class="p">,</span> <span class="mf">2.358</span><span class="p">,</span> <span class="mf">2.568</span><span class="p">,</span> <span class="mf">2.268</span><span class="p">,</span> <span class="mf">2.402</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.265</span><span class="p">,</span> <span class="mf">3.862</span><span class="p">,</span> <span class="mf">1.921</span><span class="p">,</span> <span class="mf">1.685</span><span class="p">,</span> <span class="mf">2.480</span><span class="p">],</span> <span class="p">[</span><span class="mf">2.410</span><span class="p">,</span> <span class="mf">2.340</span><span class="p">,</span> <span class="mf">2.200</span><span class="p">,</span> <span class="mf">2.540</span><span class="p">,</span> <span class="mf">2.464</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">3.47e+09</span><span class="p">,</span> <span class="mf">3.31e+06</span><span class="p">,</span> <span class="mf">2.13e+09</span><span class="p">,</span> <span class="mf">1.64e+10</span><span class="p">,</span> <span class="mf">1.01e+09</span><span class="p">],</span>
                                <span class="p">[</span><span class="mf">3.84e+09</span><span class="p">,</span> <span class="mf">1.57e+06</span><span class="p">,</span> <span class="mf">3.91e+08</span><span class="p">,</span> <span class="mf">4.66e+10</span><span class="p">,</span> <span class="mf">3.03e+07</span><span class="p">]]</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating simulated star+galaxy counts...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>

        <span class="n">mag_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="n">b_mag_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]),</span> <span class="n">mag_ind</span><span class="p">]</span>

        <span class="n">hist_mag</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">b_mag_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">minmag</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Ensure that we&#39;re only counting sources for normalisation purposes</span>
        <span class="c1"># down to the completeness turnover.</span>
        <span class="c1"># TODO: make the half-mag offset flexible, passing from CrossMatch and/or</span>
        <span class="c1"># directly into AstrometricCorrections.</span>
        <span class="n">maxmag</span> <span class="o">=</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">hist_mag</span><span class="p">)]</span> <span class="o">-</span> <span class="mf">0.5</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_download</span> <span class="ow">or</span> <span class="ow">not</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_faint.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">triname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)))):</span>
            <span class="c1"># Have to check for the existence of the folder as well as just</span>
            <span class="c1"># the lack of file. However, we can&#39;t guarantee that self.triname</span>
            <span class="c1"># doesn&#39;t contain folder sub-structure (e.g.</span>
            <span class="c1"># trifolder/ax1/ax2/file_faint.dat) and hence check generically.</span>
            <span class="n">base_auf_folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_faint.dat&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">triname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">base_auf_folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">base_auf_folder</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">rect_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax1_min</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_max</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

            <span class="n">data_bright_dens</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">b_mag_data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b_mag_data</span> <span class="o">&lt;=</span> <span class="n">maxmag</span><span class="p">))</span> <span class="o">/</span> <span class="n">rect_area</span>
            <span class="c1"># TODO: un-hardcode min_bright_tri_number</span>
            <span class="n">min_bright_tri_number</span> <span class="o">=</span> <span class="mi">1000</span>
            <span class="n">min_area</span> <span class="o">=</span> <span class="n">min_bright_tri_number</span> <span class="o">/</span> <span class="n">data_bright_dens</span>

            <span class="n">download_trilegal_simulation</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trifilterset</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">magnum</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maglim_f</span><span class="p">,</span> <span class="n">min_area</span><span class="p">,</span>
                                         <span class="n">AV</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sigma_AV</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">total_objs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_num_faint</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;mv </span><span class="si">{}</span><span class="s1">/trilegal_auf_simulation.dat </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">_faint.dat&#39;</span>
                      <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">triname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)))</span>

        <span class="n">ax1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">ax2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="n">avs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">ax1s</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ax2s</span><span class="p">)),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">ax1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax1s</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">ax2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax2s</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;equatorial&#39;</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">degree</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">galactic</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">degree</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span>
                <span class="n">AV</span> <span class="o">=</span> <span class="n">get_AV_infinity</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">avs</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">AV</span>
        <span class="n">avs</span> <span class="o">=</span> <span class="n">avs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">tri_hist</span><span class="p">,</span> <span class="n">tri_mags</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">dtri_mags</span><span class="p">,</span> <span class="n">tri_uncert</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">make_tri_counts</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trifolder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">triname</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">trifiltname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">b_mag_data</span><span class="p">),</span> <span class="n">maxmag</span><span class="p">,</span> <span class="n">al_av</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_alav</span><span class="p">,</span> <span class="n">av_grid</span><span class="o">=</span><span class="n">avs</span><span class="p">)</span>

        <span class="n">gal_dNs</span> <span class="o">=</span> <span class="n">create_galaxy_counts</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gal_cmau_array</span><span class="p">,</span> <span class="n">tri_mags</span><span class="o">+</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">41</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gal_wav_micron</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alpha1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alphaweight</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gal_ab_offset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_filtname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_alav</span><span class="o">*</span><span class="n">avs</span><span class="p">)</span>

        <span class="n">log10y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">tri_hist</span> <span class="o">+</span> <span class="n">gal_dNs</span><span class="p">)</span>
        <span class="n">new_uncert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tri_uncert</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.05</span><span class="o">*</span><span class="n">gal_dNs</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dlog10y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">new_uncert</span> <span class="o">/</span> <span class="p">(</span><span class="n">tri_hist</span> <span class="o">+</span> <span class="n">gal_dNs</span><span class="p">)</span>

        <span class="n">mag_slice</span> <span class="o">=</span> <span class="p">(</span><span class="n">tri_mags</span> <span class="o">&gt;=</span> <span class="n">minmag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tri_mags</span><span class="o">+</span><span class="n">dtri_mags</span> <span class="o">&lt;=</span> <span class="n">maxmag</span><span class="p">)</span>
        <span class="n">N_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">log10y</span><span class="p">[</span><span class="n">mag_slice</span><span class="p">]</span> <span class="o">*</span> <span class="n">dtri_mags</span><span class="p">[</span><span class="n">mag_slice</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log10y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlog10y</span> <span class="o">=</span> <span class="n">log10y</span><span class="p">,</span> <span class="n">dlog10y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tri_hist</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span> <span class="o">=</span> <span class="n">tri_hist</span><span class="p">,</span> <span class="n">tri_mags</span><span class="p">,</span> <span class="n">dtri_mags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tri_uncert</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_dNs</span> <span class="o">=</span> <span class="n">tri_uncert</span><span class="p">,</span> <span class="n">gal_dNs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minmag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxmag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_norm</span> <span class="o">=</span> <span class="n">minmag</span><span class="p">,</span> <span class="n">maxmag</span><span class="p">,</span> <span class="n">N_norm</span></div>


<div class="viewcode-block" id="AstrometricCorrections.plot_star_galaxy_counts">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.plot_star_galaxy_counts">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_star_galaxy_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plotting routine to display data and model differential source counts,</span>
<span class="sd">        for verification purposes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gridspec</span><span class="p">(</span><span class="s1">&#39;123123&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting data and model counts...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>

        <span class="c1"># Unit area is cos(t) dt dx for 0 &lt;= t &lt;= 90deg, 0 &lt;= x &lt;= 360 deg,</span>
        <span class="c1"># integrated between ax2_min &lt; t &lt; ax2_max, ax1_min &lt; x &lt; ax1_max, converted</span>
        <span class="c1"># to degrees.</span>
        <span class="n">rect_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax1_min</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_max</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="n">mag_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="n">data_mags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]),</span> <span class="n">mag_ind</span><span class="p">]</span>
        <span class="c1"># Correction to model is the ratio of data counts per unit area</span>
        <span class="c1"># to model source density.</span>
        <span class="n">correction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">data_mags</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minmag</span><span class="p">)</span> <span class="o">&amp;</span>
                            <span class="p">(</span><span class="n">data_mags</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxmag</span><span class="p">))</span> <span class="o">/</span> <span class="n">rect_area</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_norm</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax1_name</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;RA&#39;</span>
        <span class="n">ax2_name</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;Dec&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">, </span><span class="si">{}</span><span class="s1"> = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_name</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_name</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log10y</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">correction</span><span class="p">),</span>
                    <span class="n">yerr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dlog10y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="n">data_hist</span><span class="p">,</span> <span class="n">data_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">data_mags</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">d_hc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_hist</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">data_hist</span> <span class="o">=</span> <span class="n">data_hist</span><span class="p">[</span><span class="n">d_hc</span><span class="p">]</span>
        <span class="n">data_dbins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data_bins</span><span class="p">)[</span><span class="n">d_hc</span><span class="p">]</span>
        <span class="n">data_bins</span> <span class="o">=</span> <span class="n">data_bins</span><span class="p">[</span><span class="n">d_hc</span><span class="p">]</span>

        <span class="n">data_uncert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">data_hist</span><span class="p">)</span> <span class="o">/</span> <span class="n">data_dbins</span> <span class="o">/</span> <span class="n">rect_area</span>
        <span class="n">data_hist</span> <span class="o">=</span> <span class="n">data_hist</span> <span class="o">/</span> <span class="n">data_dbins</span> <span class="o">/</span> <span class="n">rect_area</span>
        <span class="n">data_loghist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">data_hist</span><span class="p">)</span>
        <span class="n">data_dloghist</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="n">data_uncert</span> <span class="o">/</span> <span class="n">data_hist</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">data_bins</span><span class="o">+</span><span class="n">data_dbins</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">data_loghist</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">data_dloghist</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

        <span class="n">lims</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri_hist</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_hist</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="o">+</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">correction</span><span class="p">),</span> <span class="s1">&#39;b--&#39;</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gal_dNs</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gal_dNs</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="o">+</span>
                <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">correction</span><span class="p">),</span> <span class="s1">&#39;b:&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">*</span><span class="n">lims</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Magnitude&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">\left(\mathrm</span><span class="si">{D}</span><span class="s1">\ /\ \mathrm</span><span class="si">{mag}</span><span class="s1">^{-1}\,&#39;</span>
                          <span class="sa">r</span><span class="s1">&#39;\mathrm</span><span class="si">{deg}</span><span class="s1">^{-2}\right)$&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;log10(D / mag^-1 deg^-2)&#39;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="s1">&#39;123123&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf/counts_comparison_</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="AstrometricCorrections.calculate_local_densities_and_nearest_neighbours">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.calculate_local_densities_and_nearest_neighbours">[docs]</a>
    <span class="k">def</span> <span class="nf">calculate_local_densities_and_nearest_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate local normalising catalogue densities and catalogue-catalogue</span>
<span class="sd">        nearest neighbour match pairings for each cutout region.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating local densities and nearest neighbour matches...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>

        <span class="n">lon_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">ax1_max</span><span class="o">-</span><span class="n">ax1_min</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">lat_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">ax2_max</span><span class="o">-</span><span class="n">ax2_min</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">Narray</span> <span class="o">=</span> <span class="n">create_densities</span><span class="p">(</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minmag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxmag</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">,</span> <span class="n">lat_slice</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span>
            <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dens_search_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_pool</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">bmatch</span><span class="p">,</span> <span class="n">dists</span> <span class="o">=</span> <span class="n">create_distances</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nn_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span><span class="p">)</span>

        <span class="c1"># TODO: extend to 3-D search around N-m-sig to find as many good</span>
        <span class="c1"># enough bins as possible, instead of only keeping one N-sig bin</span>
        <span class="c1"># per magnitude?</span>
        <span class="n">_h</span><span class="p">,</span> <span class="n">_b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">Narray</span><span class="p">[</span><span class="n">bmatch</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="n">modeN</span> <span class="o">=</span> <span class="p">(</span><span class="n">_b</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">_b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">_h</span><span class="p">)]</span>
        <span class="n">dN</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">modeN</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dists</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span> <span class="o">=</span> <span class="n">Narray</span><span class="p">,</span> <span class="n">dists</span><span class="p">,</span> <span class="n">bmatch</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dN</span> <span class="o">=</span> <span class="n">modeN</span><span class="p">,</span> <span class="n">dN</span></div>


<div class="viewcode-block" id="AstrometricCorrections.simulate_aufs">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.simulate_aufs">[docs]</a>
    <span class="k">def</span> <span class="nf">simulate_aufs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulate unresolved blended contaminants for each magnitude-sightline</span>
<span class="sd">        combination, for both aperture photometry and background-dominated PSF</span>
<span class="sd">        algorithms.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating AUF simulations...&#39;</span><span class="p">)</span>

        <span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="n">B</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="c1"># Self-consistent, non-zeropointed &quot;flux&quot;, based on the relation</span>
        <span class="c1"># given in make_snr_model.</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)</span>
        <span class="n">snr</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">flux</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="n">flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">dm_max</span> <span class="o">=</span> <span class="n">_calculate_magnitude_offsets</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">snr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log10y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_norm</span><span class="p">)</span>

        <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">paf</span><span class="o">.</span><span class="n">get_random_seed_size</span><span class="p">(),</span>
                                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">four_off_fw</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="n">paf</span><span class="o">.</span><span class="n">perturb_aufs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log10y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_norm</span><span class="p">,</span> <span class="p">(</span><span class="n">dm_max</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmcut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psfsig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_cut</span><span class="p">,</span> <span class="s1">&#39;fw&#39;</span><span class="p">)</span>

        <span class="n">seed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">100000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">paf</span><span class="o">.</span><span class="n">get_random_seed_size</span><span class="p">(),</span>
                                                            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)))</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">four_off_ps</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
            <span class="n">paf</span><span class="o">.</span><span class="n">perturb_aufs</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tri_mags</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtri_mags</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log10y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_norm</span><span class="p">,</span> <span class="p">(</span><span class="n">dm_max</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dm</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">dmcut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psfsig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">numtrials</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dd_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_cut</span><span class="p">,</span> <span class="s1">&#39;psf&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">four_off_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_off_ps</span> <span class="o">=</span> <span class="n">four_off_fw</span><span class="p">,</span> <span class="n">four_off_ps</span></div>


<div class="viewcode-block" id="AstrometricCorrections.create_auf_pdfs">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.create_auf_pdfs">[docs]</a>
    <span class="k">def</span> <span class="nf">create_auf_pdfs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Using perturbation AUF simulations, generate probability density functions</span>
<span class="sd">        of perturbation distance for all cutout regions, as well as recording key</span>
<span class="sd">        statistics such as average magnitude or SNR.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating catalogue AUF probability densities...&#39;</span><span class="p">)</span>
        <span class="n">b_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span>

        <span class="n">skip_flags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">pdfs</span><span class="p">,</span> <span class="n">pdf_uncerts</span><span class="p">,</span> <span class="n">q_pdfs</span><span class="p">,</span> <span class="n">pdf_bins</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="n">avg_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">avg_snr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>
        <span class="n">avg_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>

        <span class="n">mag_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)):</span>
            <span class="n">mag_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                       <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mag_cut</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">skip_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pdf_uncerts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">q_pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pdf_bins</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">b_matches</span><span class="p">[</span><span class="n">mag_cut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span> <span class="mi">50</span><span class="p">)</span>
                <span class="n">sig_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&lt;=</span> <span class="n">sig</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">sig</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">b_matches</span><span class="p">[</span><span class="n">mag_cut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]],</span>
                                    <span class="mi">50</span><span class="p">)</span>
                <span class="n">sig_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]</span> <span class="o">&lt;=</span>
                            <span class="n">sig</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]</span> <span class="o">&gt;=</span>
                            <span class="n">sig</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">N_cut</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dN</span><span class="p">)</span>

            <span class="c1"># Since we expect the astrometric/photometric scaling to be roughly</span>
            <span class="c1"># a factor FWHM/(2 * sqrt(2 * ln(2))), i.e. the sigma of a</span>
            <span class="c1"># Gaussian-ish PSF, scale the &quot;20-sigma&quot; cut accordingly:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                <span class="n">final_slice</span> <span class="o">=</span> <span class="n">sig_cut</span> <span class="o">&amp;</span> <span class="n">mag_cut</span> <span class="o">&amp;</span> <span class="n">N_cut</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_slice</span> <span class="o">=</span> <span class="n">sig_cut</span> <span class="o">&amp;</span> <span class="n">mag_cut</span> <span class="o">&amp;</span> <span class="n">N_cut</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psfsig</span><span class="o">*</span><span class="n">sig</span><span class="p">)</span>
            <span class="n">final_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dists</span><span class="p">[</span><span class="n">final_slice</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">final_dists</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
                <span class="n">skip_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pdf_uncerts</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">q_pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">pdf_bins</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">continue</span>

            <span class="n">bm</span> <span class="o">=</span> <span class="n">b_matches</span><span class="p">[</span><span class="n">final_slice</span><span class="p">]</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]</span> <span class="o">/</span> <span class="mf">2.5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr</span><span class="p">)</span>
            <span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">snr</span><span class="p">,</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">snr</span><span class="p">))</span>
            <span class="n">avg_mag</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">])</span>
            <span class="n">avg_mag</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">])</span> <span class="o">-</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                <span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
                <span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span>
                                                          <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">])</span> <span class="o">-</span>
                                            <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]])</span>
                <span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]],</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">84</span><span class="p">])</span> <span class="o">-</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bm</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]))</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">final_dists</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="n">pdf</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="n">pdf_uncert</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span> <span class="o">/</span> <span class="n">num</span>
            <span class="c1"># To avoid binned_statistic NaNing when the data are beyond the</span>
            <span class="c1"># edge of the model, we want to limit our bins to the maximum r value.</span>
            <span class="n">q_pdf</span> <span class="o">=</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">)</span>
            <span class="n">pdf_uncerts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf_uncert</span><span class="p">)</span>
            <span class="n">q_pdfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q_pdf</span><span class="p">)</span>
            <span class="n">pdf_bins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bins</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_mag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_sig</span> <span class="o">=</span> <span class="n">avg_snr</span><span class="p">,</span> <span class="n">avg_mag</span><span class="p">,</span> <span class="n">avg_sig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_uncerts</span> <span class="o">=</span> <span class="n">pdfs</span><span class="p">,</span> <span class="n">pdf_uncerts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q_pdfs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_bins</span> <span class="o">=</span> <span class="n">q_pdfs</span><span class="p">,</span> <span class="n">pdf_bins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_flags</span> <span class="o">=</span> <span class="n">skip_flags</span></div>


<div class="viewcode-block" id="AstrometricCorrections.fit_uncertainty">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.fit_uncertainty">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_uncertainty</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For all magnitudes for eachsightline, fit for the empirical centroid</span>
<span class="sd">        uncertainty relationship that describes the distribution of match</span>
<span class="sd">        separations.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        m : float</span>
<span class="sd">            The multiplicative factor for converting old uncertainties to new</span>
<span class="sd">            astrometric precision.</span>
<span class="sd">        n : float</span>
<span class="sd">            Quadratically added constant uncertainty to add to scaling between</span>
<span class="sd">            input and output uncertainties.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating joint H/sig fits...&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_auf_joint</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
                       <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span>

        <span class="n">cov</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">hess_inv</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">om</span><span class="p">,</span> <span class="n">on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">skip_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">continue</span>
            <span class="n">sig_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">new_sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">sig_orig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_sig</span>
            <span class="c1"># sig_sig = sqrt((dsig_dm * sig_m)**2 + (dsig_dn * sig_n)**2);</span>
            <span class="c1"># sig = sqrt((m * sig_orig)**2 + n)</span>
            <span class="n">do_dm</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">sig_orig</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">sig_orig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">do_dn</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">sig_orig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1"># Bother propagating standard deviation in sig_orig?</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">do_dm</span> <span class="o">*</span> <span class="n">om</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">do_dn</span> <span class="o">*</span> <span class="n">on</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span><span class="p">,</span> <span class="n">n</span></div>


<div class="viewcode-block" id="AstrometricCorrections.fit_auf_joint">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.fit_auf_joint">[docs]</a>
    <span class="k">def</span> <span class="nf">fit_auf_joint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fits all magnitude slices for a single sightline, modelling</span>
<span class="sd">        empirically derived centroid uncertainties in all cases in addition</span>
<span class="sd">        to fixed uncertainty contributions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        p : list</span>
<span class="sd">            List containing the two scaling values to be fit for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        chi_sq : float</span>
<span class="sd">            Chi-squared of the fit, to be minimised in the wrapping function call.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="n">m</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">p</span>

        <span class="n">chi_sq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ndof</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span>
             <span class="n">snr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_uncerts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_bins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">avg_sig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">H</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">snr</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">four_combined</span> <span class="o">=</span> <span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_off_fw</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">H</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_off_ps</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>

            <span class="n">o</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">m</span> <span class="o">*</span> <span class="n">sig</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">four_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">o</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

            <span class="n">convolve_hist</span> <span class="o">=</span> <span class="n">paf</span><span class="o">.</span><span class="n">fourier_transform</span><span class="p">(</span>
                <span class="n">four_combined</span><span class="o">*</span><span class="n">four_gauss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">)</span>

            <span class="n">convolve_hist_dr</span> <span class="o">=</span> <span class="n">convolve_hist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span>

            <span class="c1"># We have two components to fit to our data: first, some fraction F</span>
            <span class="c1"># of the objects do not have a counterpart and therefore follow</span>
            <span class="c1"># a nearest-neighbour distribution, n(r), while 1-F of the objects follow</span>
            <span class="c1"># an NN-contaminated counterpart distribution, m(r).</span>
            <span class="c1"># Here n(r) = 2 pi r rho exp(-pi r^2 rho) and</span>
            <span class="c1"># N(r) = \int_0^r n(r&#39;) dr&#39; = 1 - exp(-pi r^2 rho).</span>
            <span class="c1"># We then have to consider two contributions to our match distribution;</span>
            <span class="c1"># the match could either be a counterpart if there&#39;s no NN inside of it,</span>
            <span class="c1"># or an NN if there&#39;s no counterpart inside of it, and hence</span>
            <span class="c1"># m(r) = c(r)[1 - N(r)] + n(r)[1 - C(r)], with c(r) the empirical</span>
            <span class="c1"># distribution of counterparts and C(r) = \int_0^r c(r&#39;) dr&#39;.</span>
            <span class="c1"># Finally, the combination y(r) = F n(r) + (1 - F) m(r).</span>

            <span class="c1"># For a symmetric nearest neighbour distribution we need to use the</span>
            <span class="c1"># combined density of sources -- this is derived from consideration</span>
            <span class="c1"># of the probability of no NN object inside r being the chance that</span>
            <span class="c1"># NEITHER source has an asymmetric nearest neighbour inside r, or</span>
            <span class="c1"># F(r) = (1 - \int a(r) dr) * (1 - \int b(r) dr), where the integrals</span>
            <span class="c1"># of a and b, being of the form 2 pi r N exp(-pi r^2 N) are</span>
            <span class="c1"># 1 - exp(-pi r^2 N), and hence the survival integrals multiplied</span>
            <span class="c1"># together form N&#39; = N_a + N_b, and then you use f(r) = dF/dr.</span>
            <span class="c1"># Unit area is cos(t) dt dx for 0 &lt;= t &lt;= 90deg, 0 &lt;= x &lt;= 360 deg,</span>
            <span class="c1"># integrated between ax2_min &lt; t &lt; ax2_max, ax1_min &lt; x &lt; ax1_max, converted</span>
            <span class="c1"># to degrees.</span>
            <span class="n">rect_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax1_min</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_max</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">avg_a_dens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">rect_area</span>
            <span class="n">density</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modeN</span> <span class="o">+</span> <span class="n">avg_a_dens</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">nn_model</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">density</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)</span>

            <span class="n">m_conv_plus_nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">convolve_hist_dr</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
                              <span class="n">density</span><span class="p">))</span> <span class="o">+</span> <span class="n">nn_model</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">convolve_hist_dr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">))</span>
            <span class="c1"># Normalise m(r) so that it integrates to unity inside R.</span>
            <span class="n">qq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">bins</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">int_m_c_p_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m_conv_plus_nn</span><span class="p">[</span><span class="n">qq</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">[</span><span class="n">qq</span><span class="p">])</span>
            <span class="n">m_conv_plus_nn</span> <span class="o">/=</span> <span class="n">int_m_c_p_nn</span>

            <span class="c1"># Normalise n(r) so it integrates to unity inside R as well.</span>
            <span class="n">reduced_nn_model</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">nn_model</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">q</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="n">reduced_m_conv_plus_nn</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                                            <span class="n">m_conv_plus_nn</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

            <span class="c1"># For the subset of data in the single magnitude slice we need</span>
            <span class="c1"># a nearest neighbour fraction, which we can fit for on-the-fly</span>
            <span class="c1"># for each slice separately (for the same m/n). Here we have</span>
            <span class="c1"># x2 = sum_i ((y_i - f_i(F))**2 / o_yi**2),</span>
            <span class="c1"># f_i(F) = F a_i + (1-F) b_i, giving</span>
            <span class="c1"># F = [sum_i (y_i - b_i)*(a_i - b_i) / i_yi**2] /</span>
            <span class="c1">#      [sum_i (a_i - b_i)**2 / i_yi**2];</span>
            <span class="c1"># here a &lt;-&gt; n and b &lt;-&gt; m, and hence</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">reduced_nn_model</span><span class="p">,</span> <span class="n">reduced_m_conv_plus_nn</span>
            <span class="n">nnf</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q</span><span class="p">])</span> <span class="o">/</span> <span class="n">dy</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">dy</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="c1"># Since this should be parabolic in F, cap at the bounded limits.</span>
            <span class="n">nnf</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nnf</span><span class="p">))</span>

            <span class="n">tot_model</span> <span class="o">=</span> <span class="n">nnf</span> <span class="o">*</span> <span class="n">nn_model</span> <span class="o">/</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">q</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
                <span class="mi">1</span> <span class="o">-</span> <span class="n">nnf</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_conv_plus_nn</span>

            <span class="n">modely</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">tot_model</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>

            <span class="n">chi_sq</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">y</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">-</span> <span class="n">modely</span><span class="p">[</span><span class="n">q</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">dy</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ndof</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chi_sq</span></div>


<div class="viewcode-block" id="AstrometricCorrections.plot_fits_calculate_chi_sq">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.plot_fits_calculate_chi_sq">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_fits_calculate_chi_sq</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate chi-squared value and create verification plots showing the</span>
<span class="sd">        quality of the fits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span>
        <span class="n">x2s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating individual AUF figures and calculating goodness-of-fits...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Calculating goodness-of-fits...&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
            <span class="c1"># Grid just big enough square to cover mag_array entries.</span>
            <span class="n">gs1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_gridspec</span><span class="p">(</span><span class="s1">&#39;34242b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mag_rows</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_mag_cols</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
            <span class="n">ax1s</span> <span class="o">=</span> <span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">gs1</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">))]</span>

        <span class="n">b_matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">)):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_flags</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">continue</span>
            <span class="n">pdf</span><span class="p">,</span> <span class="n">pdf_uncert</span><span class="p">,</span> <span class="n">q_pdf</span><span class="p">,</span> <span class="n">pdf_bin</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_uncerts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">q_pdfs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdf_bins</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">((</span><span class="n">pdf_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pdf_bin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q_pdf</span><span class="p">],</span> <span class="n">pdf</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">],</span>
                            <span class="n">yerr</span><span class="o">=</span><span class="n">pdf_uncert</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>

            <span class="n">mag_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span>
            <span class="n">pos_err_ind</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">mag_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                       <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                <span class="n">bsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">b_matches</span><span class="p">[</span><span class="n">mag_cut</span><span class="p">,</span> <span class="n">pos_err_ind</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span>
                <span class="n">sig_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">pos_err_ind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bsig</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="n">pos_err_ind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bsig</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bsig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">b_matches</span><span class="p">[</span><span class="n">mag_cut</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]],</span>
                                     <span class="mi">50</span><span class="p">)</span>
                <span class="n">sig_cut</span> <span class="o">=</span> <span class="p">((</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]</span> <span class="o">&lt;=</span>
                            <span class="n">bsig</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">b_matches</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]]</span> <span class="o">&gt;=</span>
                            <span class="n">bsig</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sig_slice</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="n">N_cut</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modeN</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dN</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_photometric_uncertainties</span><span class="p">:</span>
                <span class="n">final_slice</span> <span class="o">=</span> <span class="n">sig_cut</span> <span class="o">&amp;</span> <span class="n">mag_cut</span> <span class="o">&amp;</span> <span class="n">N_cut</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">*</span><span class="n">bsig</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">final_slice</span> <span class="o">=</span> <span class="n">sig_cut</span> <span class="o">&amp;</span> <span class="n">mag_cut</span> <span class="o">&amp;</span> <span class="n">N_cut</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dists</span> <span class="o">&lt;=</span> <span class="mi">20</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psfsig</span><span class="o">*</span><span class="n">bsig</span><span class="p">)</span>
            <span class="n">bm</span> <span class="o">=</span> <span class="n">b_matches</span><span class="p">[</span><span class="n">final_slice</span><span class="p">]</span>

            <span class="n">rect_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_max</span> <span class="o">-</span> <span class="p">(</span><span class="n">ax1_min</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_max</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">ax2_min</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">180</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">avg_a_dens</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">rect_area</span>
            <span class="n">density</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Narray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bmatch</span><span class="p">][</span><span class="n">final_slice</span><span class="p">],</span> <span class="mi">50</span><span class="p">)</span> <span class="o">+</span>
                       <span class="n">avg_a_dens</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3600</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">nn_model</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">density</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)</span>

            <span class="n">fit_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">H</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">best_mag_index</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">ax1s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                    <span class="n">labels_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;H/$\sigma_\mathrm</span><span class="si">{fit}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;1/$\sigma_\mathrm</span><span class="si">{fit}</span><span class="s1">$&#39;</span><span class="p">,</span>
                                   <span class="sa">r</span><span class="s1">&#39;0/$\sigma_\mathrm</span><span class="si">{fit}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;H/$\sigma_\mathrm</span><span class="si">{quoted}</span><span class="s1">$&#39;</span><span class="p">,</span>
                                   <span class="sa">r</span><span class="s1">&#39;1/$\sigma_\mathrm</span><span class="si">{quoted}</span><span class="s1">$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;0/$\sigma_\mathrm</span><span class="si">{quoted}</span><span class="s1">$&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">labels_list</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;H/sigma_fit&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;1/sigma_fit&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;0/sigma_fit&#39;</span><span class="p">,</span>
                                   <span class="sa">r</span><span class="s1">&#39;H/sigma_quoted&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;1/sigma_quoted&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;0/sigma_quoted&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">_H</span><span class="p">,</span> <span class="n">ls</span><span class="p">,</span> <span class="n">lab</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">fit_sig</span><span class="p">,</span> <span class="n">fit_sig</span><span class="p">,</span> <span class="n">fit_sig</span><span class="p">,</span> <span class="n">bsig</span><span class="p">,</span> <span class="n">bsig</span><span class="p">,</span> <span class="n">bsig</span><span class="p">],</span> <span class="p">[</span><span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                    <span class="p">[</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="s1">&#39;r-.&#39;</span><span class="p">,</span> <span class="s1">&#39;r:&#39;</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="s1">&#39;k-.&#39;</span><span class="p">,</span> <span class="s1">&#39;k:&#39;</span><span class="p">],</span> <span class="n">labels_list</span><span class="p">)):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">four_gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sig</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

                <span class="n">four_hist</span> <span class="o">=</span> <span class="n">_H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_off_fw</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">_H</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">four_off_ps</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
                <span class="n">convolve_hist</span> <span class="o">=</span> <span class="n">paf</span><span class="o">.</span><span class="n">fourier_transform</span><span class="p">(</span>
                    <span class="n">four_hist</span><span class="o">*</span><span class="n">four_gauss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">drho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j0s</span><span class="p">)</span>

                <span class="n">convolve_hist_dr</span> <span class="o">=</span> <span class="n">convolve_hist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span>

                <span class="n">m_conv_plus_nn</span> <span class="o">=</span> <span class="p">(</span><span class="n">convolve_hist_dr</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span>
                                  <span class="n">density</span><span class="p">))</span> <span class="o">+</span> <span class="n">nn_model</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">convolve_hist_dr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">))</span>

                <span class="c1"># Normalise m(r) so that it integrates to unity inside R.</span>
                <span class="n">qq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&lt;=</span> <span class="n">pdf_bin</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">int_m_c_p_nn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">m_conv_plus_nn</span><span class="p">[</span><span class="n">qq</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">[</span><span class="n">qq</span><span class="p">])</span>
                <span class="n">m_conv_plus_nn</span> <span class="o">/=</span> <span class="n">int_m_c_p_nn</span>

                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># Normalise NN distribution so it also integrates to 1 inside R.</span>
                    <span class="n">reduced_nn_model</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">nn_model</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">pdf_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">q_pdf</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)),</span>
                        <span class="n">bins</span><span class="o">=</span><span class="n">pdf_bin</span><span class="p">)</span>
                    <span class="n">reduced_m_conv_plus_nn</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
                                                                    <span class="n">m_conv_plus_nn</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">pdf_bin</span><span class="p">)</span>

                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">reduced_nn_model</span><span class="p">,</span> <span class="n">reduced_m_conv_plus_nn</span>
                    <span class="n">nn_frac</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pdf</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">])</span> <span class="o">/</span>
                                      <span class="n">pdf_uncert</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span>
                               <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">pdf_uncert</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                    <span class="n">nn_frac</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nn_frac</span><span class="p">))</span>

                <span class="n">tot_model</span> <span class="o">=</span> <span class="n">nn_frac</span> <span class="o">*</span> <span class="n">nn_model</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">pdf_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">q_pdf</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span>
                    <span class="mi">1</span> <span class="o">-</span> <span class="n">nn_frac</span><span class="p">)</span> <span class="o">*</span> <span class="n">m_conv_plus_nn</span>

                <span class="n">modely</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">binned_statistic</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">tot_model</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">pdf_bin</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">x2s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">pdf</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span> <span class="o">-</span> <span class="n">modely</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">pdf_uncert</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                    <span class="c1"># We fit the ensemble for m and n simultaneously, but ignore</span>
                    <span class="c1"># that here since we can&#39;t define DOF properly for part of</span>
                    <span class="c1"># the chi-squared.</span>
                    <span class="n">x2s</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">q_pdf</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="n">pdf_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pdf_bin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q_pdf</span><span class="p">],</span> <span class="n">modely</span><span class="p">[</span><span class="n">q_pdf</span><span class="p">],</span> <span class="n">ls</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">lab</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">_q</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">pdf_bin</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">pdf_bin</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">q_pdf</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span> <span class="n">m_conv_plus_nn</span><span class="p">[</span><span class="n">_q</span><span class="p">],</span> <span class="s1">&#39;g--&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>
                                <span class="p">(</span><span class="n">convolve_hist_dr</span><span class="p">[</span><span class="n">_q</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">_q</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)))</span> <span class="o">/</span> <span class="n">int_m_c_p_nn</span><span class="p">,</span> <span class="s1">&#39;g-.&#39;</span><span class="p">)</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="o">/</span><span class="mi">2</span><span class="p">)[</span><span class="n">_q</span><span class="p">],</span>
                                <span class="p">(</span><span class="n">nn_model</span><span class="p">[</span><span class="n">_q</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">convolve_hist_dr</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dr</span><span class="p">)[</span><span class="n">_q</span><span class="p">])</span> <span class="o">/</span>
                                <span class="n">int_m_c_p_nn</span><span class="p">,</span> <span class="s1">&#39;g:&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
                <span class="n">r_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pdf_bin</span><span class="p">[</span><span class="mi">1</span><span class="p">:][</span><span class="n">q_pdf</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1000</span><span class="p">)</span>
                <span class="c1"># NN distribution is 2 pi r N exp(-pi r^2 N),</span>
                <span class="c1"># with N converted from sq deg and r in arcseconds;</span>
                <span class="c1"># integral to R is 1 - exp(-pi R^2 N)</span>
                <span class="n">nn_dist</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_arr</span> <span class="o">*</span> <span class="n">density</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_arr</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">r_arr</span><span class="p">,</span> <span class="n">nn_dist</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">density</span><span class="p">)),</span>
                        <span class="n">c</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

                <span class="n">o_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit_sigs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;mag = </span><span class="si">{}</span><span class="s1">, H = </span><span class="si">{:.2f}</span><span class="s1">, $\sigma$ = </span><span class="si">{:.3f}</span><span class="s1">$\pm$</span><span class="si">{:.3f}</span><span class="s1"> (</span><span class="si">{:.3f}</span><span class="s1">)&quot;; &#39;</span>
                                 <span class="sa">r</span><span class="s1">&#39;$F$ = </span><span class="si">{:.2f}</span><span class="s1">; SNR = </span><span class="si">{:.2f}</span><span class="s1">$^{{+</span><span class="si">{:.2f}</span><span class="s1">}}_{{-</span><span class="si">{:.2f}</span><span class="s1">}}$; &#39;</span>
                                 <span class="sa">r</span><span class="s1">&#39;N = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">fit_sig</span><span class="p">,</span>
                                                  <span class="n">o_sig</span><span class="p">,</span> <span class="n">bsig</span><span class="p">,</span> <span class="n">nn_frac</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">bm</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;mag = </span><span class="si">{}</span><span class="s1">, H = </span><span class="si">{:.2f}</span><span class="s1">, sigma = </span><span class="si">{:.3f}</span><span class="s1">+/-</span><span class="si">{:.3f}</span><span class="s1"> (</span><span class="si">{:.3f}</span><span class="s1">)&quot;; &#39;</span>
                                 <span class="sa">r</span><span class="s1">&#39;F = </span><span class="si">{:.2f}</span><span class="s1">; SNR = </span><span class="si">{:.2f}</span><span class="s1">+</span><span class="si">{:.2f}</span><span class="s1">/-</span><span class="si">{:.2f}</span><span class="s1">; &#39;</span>
                                 <span class="sa">r</span><span class="s1">&#39;N = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_array</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">H</span><span class="p">,</span> <span class="n">fit_sig</span><span class="p">,</span>
                                                  <span class="n">o_sig</span><span class="p">,</span> <span class="n">bsig</span><span class="p">,</span> <span class="n">nn_frac</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">avg_snr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">bm</span><span class="p">)),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Radius / arcsecond&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">usetex</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PDF / arcsecond$^{-1}$&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PDF / arcsecond^-1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf/auf_fits_</span><span class="si">{}</span><span class="s1">.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x2s</span> <span class="o">=</span> <span class="n">x2s</span></div>


<div class="viewcode-block" id="AstrometricCorrections.finalise_summary_plot">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.finalise_summary_plot">[docs]</a>
    <span class="k">def</span> <span class="nf">finalise_summary_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        After running all of the sightlines&#39; fits, generate a final</span>
<span class="sd">        summary plot of the sig-sig relations, quality of fits, and</span>
<span class="sd">        resulting &quot;m&quot; and &quot;n&quot; scaling parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO: put chi-squred distribution comparison back, but that needs</span>
        <span class="c1"># self.x2s saving out somehow so that we can skip to the end and just</span>
        <span class="c1"># run finalise_summary_plot on re-runs when we don&#39;t need to fit any</span>
        <span class="c1"># astrometry, and currently that isn&#39;t possible.</span>

        <span class="c1"># ax_d = plt.subplot(self.gs[1])</span>
        <span class="c1"># q = ~np.isnan(self.x2s[:, 0])</span>
        <span class="c1"># chi_sqs, dofs = self.x2s[:, 0][q].flatten(), self.x2s[:, 1][q].flatten()</span>
        <span class="c1"># chi_sq_cdf = np.empty(np.sum(q), float)</span>
        <span class="c1"># for i, (chi_sq, dof) in enumerate(zip(chi_sqs, dofs)):</span>
        <span class="c1">#     chi_sq_cdf[i] = chi2.cdf(chi_sq, dof)</span>
        <span class="c1"># # Under the hypothesis all CDFs are &quot;true&quot; we should expect</span>
        <span class="c1"># # the distribution of CDFs to be linear with fraction of the way</span>
        <span class="c1"># # through the sorted list of CDFs -- that is, the CDF ranked 30%</span>
        <span class="c1"># # in order should be ~0.3.</span>
        <span class="c1"># q_sort = np.argsort(chi_sq_cdf)</span>
        <span class="c1"># filter_log_nans = chi_sq_cdf[q_sort] &lt; 1</span>
        <span class="c1"># true_hypothesis_cdf_dist = (np.arange(1, len(chi_sq_cdf)+1, 1) - 0.5) / len(chi_sq_cdf)</span>
        <span class="c1"># ax_d.plot(np.log10(1 - chi_sq_cdf[q_sort][filter_log_nans]),</span>
        <span class="c1">#           true_hypothesis_cdf_dist[filter_log_nans], &#39;k.&#39;)</span>
        <span class="c1"># ax_d.plot(np.log10(1 - true_hypothesis_cdf_dist), true_hypothesis_cdf_dist, &#39;r--&#39;)</span>
        <span class="c1"># if usetex:</span>
        <span class="c1">#     ax_d.set_xlabel(r&#39;$\log_{10}(1 - \mathrm{CDF})$&#39;)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     ax_d.set_xlabel(r&#39;log10(1 - CDF)&#39;)</span>
        <span class="c1"># ax_d.set_ylabel(&#39;Fraction&#39;)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">m_sigs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_sigs</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;m&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">])):</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gs</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">use_gridspec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
            <span class="n">ax1_name</span> <span class="o">=</span> <span class="s1">&#39;l&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;RA&#39;</span>
            <span class="n">ax2_name</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span> <span class="k">else</span> <span class="s1">&#39;Dec&#39;</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> / deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_name</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> / deg&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax2_name</span><span class="p">))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf/sig_h_stats.pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="AstrometricCorrections.load_catalogue">
<a class="viewcode-back" href="../../api/macauff.AstrometricCorrections.html#macauff.AstrometricCorrections.load_catalogue">[docs]</a>
    <span class="k">def</span> <span class="nf">load_catalogue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_type</span><span class="p">,</span> <span class="n">sub_cat_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load specific sightline&#39;s catalogue, accounting for catalogue &quot;a&quot;</span>
<span class="sd">        vs &quot;b&quot;, filetype, and method by which sightlines are divided.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cat_type : string, &quot;a&quot; or &quot;b&quot;</span>
<span class="sd">            Identifier for which of the two catalogues to load.</span>
<span class="sd">        sub_cat_id : list</span>
<span class="sd">            Contains the variables to format the name of the catalogue with,</span>
<span class="sd">            in the sense of ``string.format(x, y, ...)``. Should either contain</span>
<span class="sd">            ax1 and ax2, or chunk ID, depending on ``coord_or_chunk``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        x : numpy.ndarray</span>
<span class="sd">            The catalogue&#39;s dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">sub_cat_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">cat_type</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="k">else</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">sub_cat_id</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">npy_or_csv</span> <span class="o">==</span> <span class="s1">&#39;npy&#39;</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_cols</span> <span class="k">if</span> <span class="n">cat_type</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span></div>
</div>



<span class="k">def</span> <span class="nf">create_densities</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">minmag</span><span class="p">,</span> <span class="n">maxmag</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">,</span> <span class="n">lat_slice</span><span class="p">,</span> <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span>
                     <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">,</span> <span class="n">search_radius</span><span class="p">,</span> <span class="n">n_pool</span><span class="p">,</span> <span class="n">save_folder</span><span class="p">,</span> <span class="n">mag_ind</span><span class="p">,</span> <span class="n">ax1_ind</span><span class="p">,</span>
                     <span class="n">ax2_ind</span><span class="p">,</span> <span class="n">coord_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate local normalising densities for all sources in catalogue &quot;b&quot;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ax1_mid : float</span>
<span class="sd">        Longitude of the center of the cutout region.</span>
<span class="sd">    ax2_mid : float</span>
<span class="sd">        Latitude of the middle of the cutout region.</span>
<span class="sd">    b : numpy.ndarray</span>
<span class="sd">        Catalogue of the sources for which astrometric corrections should be</span>
<span class="sd">        determined.</span>
<span class="sd">    minmag : float</span>
<span class="sd">        Bright limiting magnitude, fainter than which objects are used when</span>
<span class="sd">        determining the number of nearby sources for density purposes.</span>
<span class="sd">    maxmag : float</span>
<span class="sd">        Faintest magnitude within which to determine the density of catalogue</span>
<span class="sd">        ``b`` objects.</span>
<span class="sd">    lon_slice : numpy.ndarray</span>
<span class="sd">        Array of intermediate longitude values, between ``ax1_min`` and</span>
<span class="sd">        ``ax1_max``, used to load smaller sub-sets of the catalogue ``b``.</span>
<span class="sd">    lat_slice : numpy.ndarray</span>
<span class="sd">        An array of intermediate latitude values, between ``ax2_min`` and</span>
<span class="sd">        ``ax2_max``, used to load smaller sub-sets of the catalogue ``b``.</span>
<span class="sd">    ax1_min : float</span>
<span class="sd">        The minimum longitude of the box of the cutout region.</span>
<span class="sd">    ax1_max : float</span>
<span class="sd">        The maximum longitude of the box of the cutout region.</span>
<span class="sd">    ax2_min : float</span>
<span class="sd">        The minimum latitude of the box of the cutout region.</span>
<span class="sd">    ax2_max : float</span>
<span class="sd">        The maximum latitude of the box of the cutout region.</span>
<span class="sd">    search_radius : float</span>
<span class="sd">        Radius, in degrees, around which to calculate the density of objects.</span>
<span class="sd">        Smaller values will allow for more fluctuations and handle smaller scale</span>
<span class="sd">        variation better, but be subject to low-number statistics.</span>
<span class="sd">    n_pool : integer</span>
<span class="sd">        Number of parallel threads to run when calculating densities via</span>
<span class="sd">        ``multiprocessing``.</span>
<span class="sd">    save_folder : string</span>
<span class="sd">        Location on disk into which to save densities.</span>
<span class="sd">    mag_ind : integer</span>
<span class="sd">        Index in ``b`` where the magnitude being used is stored.</span>
<span class="sd">    ax1_ind : integer</span>
<span class="sd">        Index of ``b`` for the longitudinal coordinate column.</span>
<span class="sd">    ax2_ind : integer</span>
<span class="sd">        ``b`` index for the latitude data.</span>
<span class="sd">    coord_system : string</span>
<span class="sd">        Determines whether we are in equatorial or galactic coordinates for</span>
<span class="sd">        separation considerations.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Narray : numpy.ndarray</span>
<span class="sd">        The density of objects within ``search_radius`` degrees of each object</span>
<span class="sd">        in catalogue ``b``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_get_cart_kdt</span><span class="p">(</span><span class="n">coord</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience function to create a KDTree of a set of sky coordinates,</span>
<span class="sd">        represented in Cartesian space on the unit sphere.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        coord : ~`astropy.coordinates.SkyCoord`</span>
<span class="sd">            The `astropy` object containing all of the objects coordinates,</span>
<span class="sd">            as represented as Cartesian (x, y, z) coordinates on the unit sphere.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        kdt : ~`scipy.spatial.KDTree`</span>
<span class="sd">            The KDTree for ``coord`` evaluated with Cartesian coordinates.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Largely based on astropy.coordinates._get_cartesian_kdtree.</span>
        <span class="n">KDTree</span> <span class="o">=</span> <span class="n">spatial</span><span class="o">.</span><span class="n">KDTree</span>
        <span class="n">cartxyz</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span>
        <span class="n">flatxyz</span> <span class="o">=</span> <span class="n">cartxyz</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">cartxyz</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">//</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">kdt</span> <span class="o">=</span> <span class="n">KDTree</span><span class="p">(</span><span class="n">flatxyz</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">compact_nodes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">balanced_tree</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kdt</span>

    <span class="n">cutmag</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">minmag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="n">mag_ind</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">maxmag</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span><span class="p">:</span>
        <span class="n">full_cat</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">ax1_ind</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)</span>
        <span class="n">mag_cut_cat</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">cutmag</span><span class="p">,</span> <span class="n">ax1_ind</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">cutmag</span><span class="p">,</span> <span class="n">ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span>
                               <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">full_cat</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">ax1_ind</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="n">mag_cut_cat</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">cutmag</span><span class="p">,</span> <span class="n">ax1_ind</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">b</span><span class="p">[</span><span class="n">cutmag</span><span class="p">,</span> <span class="n">ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span>
                               <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>

    <span class="n">full_urepr</span> <span class="o">=</span> <span class="n">full_cat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">represent_as</span><span class="p">(</span><span class="n">UnitSphericalRepresentation</span><span class="p">)</span>
    <span class="n">full_ucoords</span> <span class="o">=</span> <span class="n">full_cat</span><span class="o">.</span><span class="n">realize_frame</span><span class="p">(</span><span class="n">full_urepr</span><span class="p">)</span>

    <span class="n">mag_cut_urepr</span> <span class="o">=</span> <span class="n">mag_cut_cat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">represent_as</span><span class="p">(</span><span class="n">UnitSphericalRepresentation</span><span class="p">)</span>
    <span class="n">mag_cut_ucoords</span> <span class="o">=</span> <span class="n">mag_cut_cat</span><span class="o">.</span><span class="n">realize_frame</span><span class="p">(</span><span class="n">mag_cut_urepr</span><span class="p">)</span>
    <span class="n">mag_cut_kdt</span> <span class="o">=</span> <span class="n">_get_cart_kdt</span><span class="p">(</span><span class="n">mag_cut_ucoords</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">Angle</span><span class="p">(</span><span class="n">search_radius</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span><span class="o">.</span><span class="n">value</span>
    <span class="n">overlap_number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="nb">int</span><span class="p">)</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">n_pool</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>
    <span class="n">iter_group</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">([</span><span class="n">full_ucoords</span><span class="p">,</span> <span class="n">mag_cut_kdt</span><span class="p">,</span> <span class="n">r</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">stuff</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">imap_unordered</span><span class="p">(</span><span class="n">ball_point_query</span><span class="p">,</span> <span class="n">iter_group</span><span class="p">,</span> <span class="n">chunksize</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">//</span><span class="n">n_pool</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">len_query</span> <span class="o">=</span> <span class="n">stuff</span>
        <span class="n">overlap_number</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">len_query</span>

    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">paf</span><span class="o">.</span><span class="n">get_circle_area_overlap</span><span class="p">(</span><span class="n">b</span><span class="p">[:,</span> <span class="n">ax1_ind</span><span class="p">],</span> <span class="n">b</span><span class="p">[:,</span> <span class="n">ax2_ind</span><span class="p">],</span> <span class="n">search_radius</span><span class="p">,</span>
                                       <span class="n">ax1_min</span><span class="p">,</span> <span class="n">ax1_max</span><span class="p">,</span> <span class="n">ax2_min</span><span class="p">,</span> <span class="n">ax2_max</span><span class="p">)</span>

    <span class="n">Narray</span> <span class="o">=</span> <span class="n">overlap_number</span> <span class="o">/</span> <span class="n">area</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/narray_sky_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">),</span> <span class="n">Narray</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">Narray</span>


<span class="k">def</span> <span class="nf">ball_point_query</span><span class="p">(</span><span class="n">iterable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Wrapper function to distribute calculation of the number of neighbours</span>
<span class="sd">    around a particular sky coordinate via KDTree query.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    iterable : list</span>
<span class="sd">        List of variables passed through ``multiprocessing``, including index</span>
<span class="sd">        into object having its neighbours determined, the Spherical Cartesian</span>
<span class="sd">        representation of objects to search for neighbours around, the KDTree</span>
<span class="sd">        containing all potential neighbours, and the Cartesian angle</span>
<span class="sd">        representing the maximum on-sky separation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    i : integer</span>
<span class="sd">        The index of the object whose neighbour count was calculated.</span>
<span class="sd">    integer</span>
<span class="sd">        The number of neighbours in ``mag_cut_kdt`` within ``r`` of</span>
<span class="sd">        ``full_ucoords[i]``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">full_ucoords</span><span class="p">,</span> <span class="n">mag_cut_kdt</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">=</span> <span class="n">iterable</span>
    <span class="c1"># query_ball_point returns the neighbours of x (full_ucoords) around self</span>
    <span class="c1"># (mag_cut_kdt) within r.</span>
    <span class="n">kdt_query</span> <span class="o">=</span> <span class="n">mag_cut_kdt</span><span class="o">.</span><span class="n">query_ball_point</span><span class="p">(</span><span class="n">full_ucoords</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">kdt_query</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_distances</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">nn_radius</span><span class="p">,</span> <span class="n">save_folder</span><span class="p">,</span> <span class="n">a_ax1_ind</span><span class="p">,</span> <span class="n">a_ax2_ind</span><span class="p">,</span>
                     <span class="n">b_ax1_ind</span><span class="p">,</span> <span class="n">b_ax2_ind</span><span class="p">,</span> <span class="n">coord_system</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate nearest neighbour matches between two catalogues.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : numpy.ndarray</span>
<span class="sd">        Array containing catalogue &quot;a&quot;&#39;s sources. Must have astrometry as its</span>
<span class="sd">        first and second columns.</span>
<span class="sd">    b : numpy.ndarray</span>
<span class="sd">        Catalogue &quot;b&quot;&#39;s object array. Longitude and latitude must be its first</span>
<span class="sd">        two axes respectively.</span>
<span class="sd">    ax1_mid : float</span>
<span class="sd">        Center of the cutout region in longitude.</span>
<span class="sd">    ax2_mid : float</span>
<span class="sd">        Latitude of the cutout region&#39;s central coordinate.</span>
<span class="sd">    nn_radius : float</span>
<span class="sd">        Maximum match radius within which to consider potential counterpart</span>
<span class="sd">        assignments, in arcseconds.</span>
<span class="sd">    save_folder : string</span>
<span class="sd">        Location on disk where matches should be saved.</span>
<span class="sd">    a_ax1_ind : integer</span>
<span class="sd">        Index into ``a`` of the longitude data.</span>
<span class="sd">    a_ax2_ind : integer</span>
<span class="sd">        ``a`` index for latitude column.</span>
<span class="sd">    b_ax1_ind : integer</span>
<span class="sd">        Longitude index in the ``b`` dataset.</span>
<span class="sd">    b_ax2_ind : integer</span>
<span class="sd">        Index into ``b`` that holds the latitude data.</span>
<span class="sd">    coord_system : string</span>
<span class="sd">        Sets coordinate system to equatorial or galactic.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    amatch : numpy.ndarray</span>
<span class="sd">        Indices in catalogue ``a`` that have a match to a source in catalogue</span>
<span class="sd">        ``b`` within ``nn_radius`` that the opposite object has as its nearest</span>
<span class="sd">        neighbour as well. ``amatch[i]`` pairs with ``bmatch[i]`` for all ``i``.</span>
<span class="sd">    bmatch : numpy.ndarray</span>
<span class="sd">        The indices into catalogue ``b`` that have a pair in catalogue ``a``,</span>
<span class="sd">        in an elementwise match between ``amatch`` and ``bmatch``.</span>
<span class="sd">    dists : numpy.ndarray</span>
<span class="sd">        The separations between each nearest neighbour match, in arcseconds.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">coord_system</span> <span class="o">==</span> <span class="s1">&#39;galactic&#39;</span><span class="p">:</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span> <span class="n">a_ax1_ind</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span> <span class="n">a_ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">b_ax1_ind</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">b_ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;galactic&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ac</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span> <span class="n">a_ax1_ind</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">a</span><span class="p">[:,</span> <span class="n">a_ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">b_ax1_ind</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">b</span><span class="p">[:,</span> <span class="n">b_ax2_ind</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;deg&#39;</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;icrs&#39;</span><span class="p">)</span>
    <span class="n">amatchind</span><span class="p">,</span> <span class="n">adists</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">ac</span><span class="p">,</span> <span class="n">bc</span><span class="p">)</span>
    <span class="n">bmatchind</span><span class="p">,</span> <span class="n">bdists</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="n">ac</span><span class="p">)</span>
    <span class="c1"># Since match_coordinates_sky doesn&#39;t set a maximum cutoff, we manually</span>
    <span class="c1"># ensure only matches within nn_radius return by setting larger matches</span>
    <span class="c1"># to unique negative indices, so that found_match_slice and</span>
    <span class="c1"># found_match_slice2 fail for those later.</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">adists</span><span class="o">.</span><span class="n">arcsecond</span> <span class="o">&gt;</span> <span class="n">nn_radius</span>
    <span class="n">amatchind</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">bdists</span><span class="o">.</span><span class="n">arcsecond</span> <span class="o">&gt;</span> <span class="n">nn_radius</span>
    <span class="n">bmatchind</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">adists</span> <span class="o">=</span> <span class="n">adists</span><span class="o">.</span><span class="n">arcsecond</span>

    <span class="n">_ainds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">found_match_slice</span> <span class="o">=</span> <span class="n">amatchind</span> <span class="o">&gt;=</span> <span class="mi">0</span>
    <span class="n">found_match_slice2</span> <span class="o">=</span> <span class="n">_ainds</span><span class="p">[</span><span class="n">found_match_slice</span><span class="p">]</span> <span class="o">==</span> <span class="n">bmatchind</span><span class="p">[</span><span class="n">amatchind</span><span class="p">[</span><span class="n">found_match_slice</span><span class="p">]]</span>

    <span class="c1"># The indices should swap here. amatchind is the catalogue b indices</span>
    <span class="c1"># for each catalogue a object, but we really just care about which</span>
    <span class="c1"># catalogue b objects are matched.</span>
    <span class="n">bmatch</span> <span class="o">=</span> <span class="n">amatchind</span><span class="p">[</span><span class="n">found_match_slice</span><span class="p">][</span><span class="n">found_match_slice2</span><span class="p">]</span>
    <span class="n">amatch</span> <span class="o">=</span> <span class="n">_ainds</span><span class="p">[</span><span class="n">found_match_slice</span><span class="p">][</span><span class="n">found_match_slice2</span><span class="p">]</span>
    <span class="n">dists</span> <span class="o">=</span> <span class="n">adists</span><span class="p">[</span><span class="n">found_match_slice</span><span class="p">][</span><span class="n">found_match_slice2</span><span class="p">]</span>

    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/a_matchind_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">),</span> <span class="n">amatch</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/b_matchind_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">),</span> <span class="n">bmatch</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/ab_dists_</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">save_folder</span><span class="p">,</span> <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">),</span> <span class="n">dists</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">amatch</span><span class="p">,</span> <span class="n">bmatch</span><span class="p">,</span> <span class="n">dists</span>


<span class="k">class</span> <span class="nc">SNRMagnitudeRelationship</span><span class="p">(</span><span class="n">AstrometricCorrections</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to derive signal-to-noise ratio-magnitude relationships for sources</span>
<span class="sd">    in photometric catalogues.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">save_folder</span><span class="p">,</span> <span class="n">ax1_mids</span><span class="p">,</span> <span class="n">ax2_mids</span><span class="p">,</span> <span class="n">ax_dimension</span><span class="p">,</span> <span class="n">npy_or_csv</span><span class="p">,</span> <span class="n">coord_or_chunk</span><span class="p">,</span>
                 <span class="n">pos_and_err_indices</span><span class="p">,</span> <span class="n">mag_indices</span><span class="p">,</span> <span class="n">mag_unc_indices</span><span class="p">,</span> <span class="n">mag_names</span><span class="p">,</span> <span class="n">coord_system</span><span class="p">,</span>
                 <span class="n">chunks</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialisation of AstrometricCorrections, accepting inputs required for</span>
<span class="sd">        the running of the optimisation and parameterisation of astrometry of</span>
<span class="sd">        a photometric catalogue, benchmarked against a catalogue of much higher</span>
<span class="sd">        astrometric resolution and precision, such as Gaia or the Hubble Source</span>
<span class="sd">        Catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        save_folder : string</span>
<span class="sd">            Absolute or relative filepath of folder into which to store</span>
<span class="sd">            temporary and generated outputs from the fitting process.</span>
<span class="sd">        ax1_mids : numpy.ndarray</span>
<span class="sd">            Array of longitudes (e.g. RA or l) used to center regions used to</span>
<span class="sd">            determine astrometric corrections across the sky. Depending on</span>
<span class="sd">            ``ax_correction``, either the unique values that with ``ax2_mids``</span>
<span class="sd">            form a rectangle, or a unique ax-ax combination with a corresponding</span>
<span class="sd">            ``ax2_mid``.</span>
<span class="sd">        ax2_mids : numpy.ndarray</span>
<span class="sd">            Array of latitudes (Dec/b) defining regions for calculating</span>
<span class="sd">            astrometric corrections. Either unique rectangle values to combine</span>
<span class="sd">            with ``ax1_mids`` or unique ``ax1_mids``-``ax2_mids`` pairs, one</span>
<span class="sd">            per entry.</span>
<span class="sd">        ax_dimension : integer, either ``1`` or ``2``</span>
<span class="sd">            If ``1`` then ``ax1_mids`` and ``ax2_mids`` form unique sides of a</span>
<span class="sd">            rectangle when combined in a grid, or if ``2`` each</span>
<span class="sd">            ``ax1_mids``-``ax2_mids`` combination is a unique ax-ax pairing used</span>
<span class="sd">            as given.</span>
<span class="sd">        npy_or_csv : string, either ``npy`` or ``csv``</span>
<span class="sd">            Indicator as to whether the small chunks of sky to be loaded for</span>
<span class="sd">            each sightline&#39;s evaluation are in binary ``numpy`` format or saved</span>
<span class="sd">            to disk as a comma-separated values file.</span>
<span class="sd">        coord_or_chunk : string, either ``coord`` or ``chunk``</span>
<span class="sd">            String indicating whether intermediate files should be saved with</span>
<span class="sd">            filenames that are unique by two coordinates (l/b or RA/Dec) or</span>
<span class="sd">            some kind of singular &quot;chunk&quot; number. Output filenames would then</span>
<span class="sd">            need to follow ``&#39;file_{}{}&#39;`` or ``&#39;file_{}&#39;`` formatting</span>
<span class="sd">            respectively.</span>
<span class="sd">        pos_and_err_indices : list or numpy.ndarray of integers</span>
<span class="sd">            In order, the indices within the catalogue, either a .npy or .csv</span>
<span class="sd">            file, of the longitudinal (e.g. RA or l), latitudinal (Dec or b),</span>
<span class="sd">            and *singular*, circular astrometric precision array. Coordinates</span>
<span class="sd">            should be in degrees while precision should be in the same units as</span>
<span class="sd">            ``sig_slice`` and those of the nearest-neighbour distances, likely</span>
<span class="sd">            arcseconds. For example, ``[0, 1, 2]`` or ``[6, 3, 0]`` where the</span>
<span class="sd">            first example has its coordinates in the first three columns in</span>
<span class="sd">            RA/Dec/Err order, while the second has its coordinates in a more</span>
<span class="sd">            random order.</span>
<span class="sd">        mag_indices : list or numpy.ndarray</span>
<span class="sd">            In appropriate order, as expected by e.g. `~macauff.CrossMatch` inputs</span>
<span class="sd">            and `~macauff.make_perturb_aufs`, list the indexes of each magnitude</span>
<span class="sd">            column within either the ``.npy`` or ``.csv`` file loaded for each</span>
<span class="sd">            sub-catalogue sightline. These should be zero-indexed.</span>
<span class="sd">        mag_unc_indices : list or numpy.ndarray</span>
<span class="sd">            For each ``mag_indices`` entry, the corresponding magnitude</span>
<span class="sd">            uncertainty index in the catalogue.</span>
<span class="sd">        mag_names : list or numpy.ndarray of strings</span>
<span class="sd">            Names of each ``mag_indices`` magnitude.</span>
<span class="sd">        coord_system : string, &quot;equatorial&quot; or &quot;galactic&quot;</span>
<span class="sd">            Identifier of which coordinate system the data are in. Both datasets</span>
<span class="sd">            must be in the same system, which can either be RA/Dec (equatorial)</span>
<span class="sd">            or l/b (galactic) coordinates.</span>
<span class="sd">        chunks = list or numpy.ndarray of strings, optional</span>
<span class="sd">            List of IDs for each unique set of data if ``coord_or_chunk`` is</span>
<span class="sd">            ``chunk``. In this case, ``ax_dimension`` must be ``2`` and each</span>
<span class="sd">            ``chunk`` must correspond to its ``ax1_mids``-``ax2_mids`` coordinate.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax_dimension must either be &#39;1&#39; or &#39;2&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">npy_or_csv</span> <span class="o">!=</span> <span class="s2">&quot;npy&quot;</span> <span class="ow">and</span> <span class="n">npy_or_csv</span> <span class="o">!=</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;npy_or_csv must either be &#39;npy&#39; or &#39;csv&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">!=</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">and</span> <span class="n">coord_or_chunk</span> <span class="o">!=</span> <span class="s2">&quot;chunk&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord_or_chunk must either be &#39;coord&#39; or &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="n">chunks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;chunks must be provided if coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="n">ax_dimension</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax_dimension must be 2, and ax1-ax2 pairings provided for each chunk &quot;</span>
                             <span class="s2">&quot;in chunks if coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s2">&quot;chunk&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ax1_mids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span> <span class="ow">or</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="n">ax2_mids</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ax1_mids, ax2_mids, and chunks must all be the same length if &quot;</span>
                             <span class="s2">&quot;coord_or_chunk is &#39;chunk&#39;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">coord_system</span> <span class="o">==</span> <span class="s2">&quot;equatorial&quot;</span> <span class="ow">or</span> <span class="n">coord_system</span> <span class="o">==</span> <span class="s2">&quot;galactic&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;coord_system must either be &#39;equatorial&#39; or &#39;galactic&#39;.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span> <span class="o">=</span> <span class="n">save_folder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span> <span class="o">=</span> <span class="n">ax1_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span> <span class="o">=</span> <span class="n">ax2_mids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ax_dimension</span> <span class="o">=</span> <span class="n">ax_dimension</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">npy_or_csv</span> <span class="o">=</span> <span class="n">npy_or_csv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">=</span> <span class="n">coord_or_chunk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span> <span class="o">=</span> <span class="n">chunks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">coord_system</span> <span class="o">=</span> <span class="n">coord_system</span>

        <span class="k">if</span> <span class="n">npy_or_csv</span> <span class="o">==</span> <span class="s1">&#39;npy&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">pos_and_err_indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span> <span class="o">=</span> <span class="n">mag_indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span> <span class="o">=</span> <span class="n">mag_unc_indices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_names</span> <span class="o">=</span> <span class="n">mag_names</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># np.genfromtxt will load in pos_and_err or pos_and_err, mag_ind,</span>
            <span class="c1"># mag_unc_ind order for the two catalogues. Each will effectively</span>
            <span class="c1"># change its ordering, since we then load [0] for pos_and_err[0][0],</span>
            <span class="c1"># etc. for all options. These need saving for np.genfromtxt but</span>
            <span class="c1"># also for obtaining the correct column in the resulting sub-set of</span>
            <span class="c1"># the loaded csv file.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">pos_and_err_indices</span><span class="p">,</span> <span class="n">mag_indices</span><span class="p">,</span> <span class="n">mag_unc_indices</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pos_and_err_indices</span> <span class="o">=</span> <span class="p">[</span>
                <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">pos_and_err_indices</span><span class="p">]]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">mag_indices</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mag_unc_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_cols</span><span class="p">))</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">mag_unc_indices</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">mag_names</span> <span class="o">=</span> <span class="n">mag_names</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">)))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_filt_cols</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span>
                       <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/pdf&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">)]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">b_cat_name</span><span class="p">,</span> <span class="n">overwrite_all_sightlines</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">make_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Call function for the correction calculation process.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a_cat_name : string</span>
<span class="sd">            Name of the catalogue &quot;b&quot; filename, pre-generated. Must accept one</span>
<span class="sd">            or two formats via Python string formatting (e.g. ``&#39;a_string_{}&#39;``)</span>
<span class="sd">            that represent ``chunk``, or ``ax1_mid`` and ``ax2_mid``, depending</span>
<span class="sd">            on ``coord_or_chunk``.</span>
<span class="sd">        overwrite_all_sightlines : boolean, optional</span>
<span class="sd">            Flag for whether to create a totally fresh run of astrometric</span>
<span class="sd">            corrections, regardless of whether ``abc_array`` is saved on disk.</span>
<span class="sd">            Defaults to ``False``.</span>
<span class="sd">        make_plots : boolean, optional</span>
<span class="sd">            Determines if intermediate figures are generated in the process</span>
<span class="sd">            of deriving astrometric corrections.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b_cat_name</span> <span class="o">=</span> <span class="n">b_cat_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_plots</span> <span class="o">=</span> <span class="n">make_plots</span>

        <span class="c1"># Force pregenerate_cutouts for super purposes.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pregenerate_cutouts</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">make_ax_coords</span><span class="p">(</span><span class="n">check_b_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Making coords/cutouts happens for all sightlines, and then we</span>
        <span class="c1"># loop through each individually:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">zip_list</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_mins</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax1_maxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ax2_mins</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ax2_maxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunks</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">overwrite_all_sightlines</span> <span class="ow">or</span>
                <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">))):</span>
            <span class="n">abc_array</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w+&#39;</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mag_indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">),</span> <span class="mi">5</span><span class="p">))</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abc_array</span> <span class="o">=</span> <span class="n">open_memmap</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/npy/snr_mag_params.npy&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_folder</span><span class="p">),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index_</span><span class="p">,</span> <span class="n">list_of_things</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">zip_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">continue</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Running SNR-mag fits for sightline </span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">index_</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ax1_mids</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">coord_or_chunk</span> <span class="o">==</span> <span class="s1">&#39;coord&#39;</span><span class="p">:</span>
                <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">list_of_things</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax1_mid</span><span class="p">,</span> <span class="n">ax2_mid</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">chunk</span> <span class="o">=</span> <span class="n">list_of_things</span>
                <span class="n">cat_args</span> <span class="o">=</span> <span class="p">(</span><span class="n">chunk</span><span class="p">,)</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_of_things</span> <span class="o">=</span> <span class="n">list_of_things</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cat_args</span> <span class="o">=</span> <span class="n">cat_args</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_catalogue</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_args</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_array</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_snr_model</span><span class="p">()</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">c_array</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax1_mid</span>
            <span class="n">abc_array</span><span class="p">[:,</span> <span class="n">index_</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax2_mid</span>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../f-modindex.html" title="Fortran Module Index"
             >fortran modules</a> |</li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">macauff</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">macauff.fit_astrometry</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2022, Tom J Wilson.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>